<!DOCTYPE html>
<html lang="en">
  <head>
      <!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125893749-1"></script>
      <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-125893749-1');
          </script>
    <title>Policeman in da Bristol city :: Kowainik</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Kowainik — Bristol Haskell Hackathon 2020 project — Policeman — a tool for Haskell PVP version suggesting.">
    <meta name="keywords" content="Haskell, Functional progarmming, FP , haskell, tool, GHC, PVP, cabal ">
    <meta name="author" content="Kowainik  — Veronika Romashkina <> Dmitrii Kovanikov " />

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@kowainik" />
    <meta property="twitter:title" content="Kowainik - Policeman in da Bristol city" />
    <meta name="twitter:description" content="Bristol Haskell Hackathon 2020 project — Policeman — a tool for Haskell PVP version suggesting." />
    <meta name="twitter:image:src" content="https://kowainik.github.io/images/logo-yellow.png" />
    <meta property="og:title" content="Kowainik - Policeman in da Bristol city" />
    <meta property="og:description" content="Bristol Haskell Hackathon 2020 project — Policeman — a tool for Haskell PVP version suggesting." />
    <meta property="og:site_name" content="Kowainik" />
    <meta property="og:image" content="https://kowainik.github.io/images/logo-yellow.png" />

    <!-- Favicon -->
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/dracula.min.css" />
    <!-- Fontawesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <!-- Custom fonts for this template -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato" />
    <!-- Custom styles for this template -->
    <link href="../css/default.css" rel="stylesheet">
    <link href="../css/post.css" rel="stylesheet">
  </head>

  <body class="body-posts">

          <!-- Header -->
      <nav class="navbar navbar-inverse navbar-fixed-left leftmenu bg-primary text-secondary">
            <div class="navbar-header text-center">
                <div class="postslogo justify-content-center"> <a href="../"><img class="img-fluid" src="../images/logo-tr.png" alt="Kowainik"></a></div>
                <div class="coffee text-center">
                    <a class="btn btn-primary rounded-pill" href="https://ko-fi.com/kowainik" target="_blank">
                        <i class="fas fa-coffee"></i> Buy a coffee
                    </a>
                </div>
                <ul class="socials empty-list list-inline mb-0 justify-content-center text-center mx-auto">
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="https://twitter.com/kowainik" target="_blank">
                        <i class="fab fa-fw fa-twitter"></i>
                    </a>
                </li>
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="https://github.com/kowainik" target="_blank">
                        <i class="fab fa-fw fa-github"></i>
                    </a>
                </li>
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="https://www.linkedin.com/company/kowainik" target="_blank">
                        <i class="fab fa-fw fa-linkedin"></i>
                    </a>
                </li>
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="https://t.me/kowainik" target="_blank">
                        <i class="fab fa-fw fa-telegram"></i>
                    </a>
                </li>
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="../rss.xml" target="_blank">
                        <i class="fas fa-fw fa-rss"></i>
                    </a>
                </li>
                
                </ul>

            </div>

            <div class="toc-zone justify-content-center">
                <h6 class="coolFont">Contents</h6>
                <div class="toc" id="main">
                    <ul>
<li><a href="#bristol-hackathon">Bristol Hackathon</a></li>
<li><a href="#policeman">Policeman</a></li>
<li><a href="#briefing">Briefing</a></li>
<li><a href="#hie-there">HIE there</a></li>
<li><a href="#case-closed">Case closed</a></li>
</ul>
                </div>
            </div>
            <div class="allposts text-center">
                <h3><a href="../posts"> Posts =<< </a></h3>
            </div>
      </nav>
      <div class="container info">
          <h2 class="text-center text-uppercase text-secondary">Policeman in da Bristol city</h2>
          <div class="row coolFont align-self-center justify-content-center">
            <div class="col-10">Date: January 29, 2020</div>
            

            <div class="author col-10">Author: Veronika Romashkina <> Dmitrii Kovanikov</div>
            <div class="col-12 text-center m-auto tag-block">
                
                <span class="tag-block"> <a class="btn btn-outline-dark btn-tag" href="../tags/haskell">haskell</a></span>
                
                <span class="tag-block"> <a class="btn btn-outline-dark btn-tag" href="../tags/tool">tool</a></span>
                
                <span class="tag-block"> <a class="btn btn-outline-dark btn-tag" href="../tags/GHC">GHC</a></span>
                
                <span class="tag-block"> <a class="btn btn-outline-dark btn-tag" href="../tags/PVP">PVP</a></span>
                
                <span class="tag-block"> <a class="btn btn-outline-dark btn-tag" href="../tags/cabal">cabal</a></span>
                
            </div>
          </div>

          <div class="content">
            <div class="row post">
              <div class="col-12 post-body">
              <p class="lead">
                  <h2 id="bristol-hackathon">Bristol Hackathon<a href="#bristol-hackathon" class="anchor">🔗</a></h2>
<p>We have just got back from the first-ever hackathon we participated in, that took place on <a href="https://mpickering.github.io/bristol2020.html">25-26 January 2020 in Bristol</a>. And we can’t wait to share our experience, since (good news) we have something to present you as the result of our productive and fun weekend!</p>
<p>But first, we would like to say thanks to the organizers of the event who brought together so many amazing Haskellers in one place. This event was fruitful on unexpected collaborations and lots of productive hours of work on diverse types of projects.</p>
<p>In this post, we want to demonstrate the output of our work at this Hackathon — the idea we had in mind for a while but did not manage to bring to life. Please, meet <em>Mr Policeman</em>!</p>
<ul>
<li><a href="https://github.com/kowainik/policeman">kowainik/policeman</a></li>
</ul>
<h2 id="policeman">Policeman<a href="#policeman" class="anchor">🔗</a></h2>
<p>In Kowainik we strive to help the Haskell ecosystem and produce beneficial libraries and tools. That is why for the two-day long Hackathon we set a goal to work on a project which helps both novices and experts. This time we decided to help ease the burden of package maintenance as this topic is of high interest to us — we deal with it on a daily basis and have firsthand experience in the process challenges. The project we were working on is called <code>Policeman</code> and it assists to properly choose the next version number for the Haskell packages based on the semantic changes in the exposed interface. But before we dive into details, let’s first talk about the official versioning policy to better understand the need in such an instrument.</p>
<p>The recommended practice for Haskell libraries is to follow <a href="https://pvp.haskell.org/">PVP</a> — Package Versioning Policy — a policy designed to handle Haskell specifics especially well. You can use other versioning strategies if you prefer, nothing stops you from doing so at any stage of the release cycle, however, different pieces of the Haskell ecosystem interact with each other more smoothly when they embody the single established format — PVP. Following the determined policy can prevent some unfortunate version incompatibility nightmares between libraries, as they depend on each other in so many ways.</p>
<p>PVP defines a <a href="https://github.com/haskell/pvp/blob/master/v1.1/pvp-specification.md">set of rules</a> of how you must change your package version in accordance with the changes in the code. Simply speaking, versions in Haskell should have a form of <strong>A.B.C.D</strong> where the components stand for the following meaning:</p>
<ul>
<li><strong>A</strong> — marketing major version; usually changed when a package had significant breaking changes</li>
<li><strong>B</strong> — major version, should be bumped up on breaking changes</li>
<li><strong>C</strong> — minor version, updated on non-breaking changes</li>
<li><strong>D</strong> — tiny minor version, updated on bug fixes, documentation patches, etc.</li>
</ul>
<p>Let’s examine some example situations. In the following stories, our current version is <strong>1.2.10.3</strong>.</p>
<p>🔍 You updated the documentation, then your new version might be <strong>1.2.10.4</strong></p>
<p>🔍 You added a new function, then your next release version should be <strong>1.2.11.0</strong></p>
<p>🔍 You deleted one of the functions exposed by your library, then you should assign a new version <strong>1.3.0.0</strong></p>
<p>🔍 You rewrote half of your library or introduced a new significant feature, then it might be a good idea to create a new major release with the version <strong>2.0.0.0</strong></p>
<p>If you browse various packages on <a href="https://hackage.haskell.org/">Hackage</a>, you may notice versions that contain a different number of components with some components skipped or added, like 1.0 or 2.0.3 or <a href="https://hackage.haskell.org/package/cctools-workqueue-3.6.1.0.1.0.0.1">3.6.1.0.1.0.0.1</a>. Even though it is not a problem for Haskell build tools since all versions can be ordered, the recommendation would still be to specify all four components for the consistent versioning scheme and avoidance of some tricky version collisions.</p>
<p>Official PVP page contains an exhaustive set of rules you can follow to properly change the version of your package. However, it is still possible to make mistakes, since the process is manual and complicated, therefore error-prone. And, what is more important, when you make a mistake, sometimes you can realise that only after releasing the package which makes the cost of the mistake extremely high. Thus, there is a need to automate this process and that is why we have created <code>policeman</code> — your versioning guard.</p>
<p>In the following section, we are going to describe our implementation flow and usage of the modern advances in Haskell tooling to achieve our set goal.</p>
<h2 id="briefing">Briefing<a href="#briefing" class="anchor">🔗</a></h2>
<p>The PVP repository contains an <a href="https://github.com/haskell/pvp/blob/master/v1.1/pvp-decision-tree.svg">algorithm in the form of a flowchart</a> which defines how the version should be assigned. However, its description is too high-level and declarative to be programmed in a straightforward way. In view of that fact, we had to come up with a more detailed plan on how to find semantic differences between the current and previous version of a package. Below you can find the description of how Policeman actually performs its duties:</p>
<ol type="1">
<li>Parses the local cabal file to get all necessary information for the proper work of the tool: package name, version, list of exposed modules, etc.</li>
<li>Uses the Hackage API to get the latest (or any other manually specified published) version of the package with the corresponding name.</li>
<li>Downloads the tar archive of the previous version into a local temporary directory and unpacks it.</li>
<li>Compiles both the current and downloaded versions to create the HIE files (will be covered more in the next section). This is the step that can be done only with GHC-8.8 or higher.</li>
<li>Retrieves the information about both packages from their <code>.cabal</code> and generated HIE files.</li>
<li>Finds the semantic diff of the exposed interface between the previous and current versions.</li>
<li>Evaluates the diff to make a decision regarding the advised new version.</li>
<li>Produces detailed output of all weighty semantic changes that affect the conclusion.</li>
</ol>
<p>You can see that the implementation involves a lot of steps of various difficulty that touches different areas — from dealing with infrastructure to writing pure languages analysis algorithms. However, being highly declarative language, Haskell allows us to implement the above plan in a modular way. With the usage of the <code>ExceptT</code> concept we managed to create a nice architecture where all that different components work smoothly together and we can get the control of error handling in a convenient and extensible way in terms of the described system.</p>
<p>Furthermore, we are separating pure logic as per the Haskell best abilities. The “pure” stages such as diff building, result evaluation and versions manipulations are completely isolated. That gives us the opportunity to provide reliable testing (both unit and property) which could be useful in feature shipping in the future as well.</p>
<p>Eventually, we were able to achieve MVP state of <code>policeman</code> in just two days. Below you can find an example of the Policeman’s work on some local changes for the <a href="https://github.com/kowainik/relude">relude</a> package:</p>
<figure>
<img src="https://user-images.githubusercontent.com/4276606/73396836-1fada980-42da-11ea-8c59-64fa985f54bc.png" alt /><figcaption>Policeman example</figcaption>
</figure>
<h2 id="hie-there">HIE there<a href="#hie-there" class="anchor">🔗</a></h2>
<p>Initially, we were considering to parse source code of the Haskell files and compare abstract syntax trees to detect the semantic difference between the given two versions. Unfortunately, this approach is not capable of handling some edgy cases, so it won’t be able to work with some packages. That is the reason why we decided to go with the HIE files as a source of truth for Policeman in the long run. <em>We are not interested in fake evidence</em> 🕵️.</p>
<p><a href="https://www.haskell.org/ghc/blog/20190626-HIEFiles.html">HIE files</a> are so useful that we decided to dedicate a whole section to them and to their usage in our project, and the role in Haskell tools of the future. They were introduced in GHC-8.8 with the goal to help IDEs and Haskell tooling in general. For example, <a href="https://github.com/digital-asset/ghcide">ghcide</a> already uses HIE files to provide smooth IDE experience. HIE files contain syntactic and semantic information collected by GHC during compilation about Haskell source code files, which can be used for various analysis purposes. Thereby, instead of parsing source code by specifying all required options from the <code>.cabal</code> files, dealing with CPP and custom preprocessors, collecting location info from dependencies, one can just take all this information from the files created by GHC specifically for the purposes of making the Haskell tooling writers’ lives easier.</p>
<p>HIE files are binary files with the <code>.hie</code> extension. They are not generated by default, in order to produce them you need to pass <a href="https://downloads.haskell.org/ghc/latest/docs/html/users_guide/separate_compilation.html#ghc-flag--fwrite-ide-info"><code>-fwrite-ide-info</code></a> flag to GHC. By default, they are put into the local build directory, but you also can use the <a href="https://downloads.haskell.org/ghc/latest/docs/html/users_guide/separate_compilation.html#ghc-flag--hiedir%20%E2%9F%A8dir%E2%9F%A9"><code>-hiedir</code></a> option to specify the output directory (which we do in <code>policeman</code>). Since these files are binary, you cannot easily open them in a text editor and immediately understand their content. You can use the <a href="https://github.com/wz1000/HieDb">HieDb</a> tool to query information about those files. If you want to analyze their content programmatically, you can add GHC as a library to the dependencies of your project and decode HIE files by a function call. In Policeman, we go for the second option and parse the content to extract the relevant information. Specifically, we are interested in the exported data types and functions and AST of exposed functions. Fortunately, HIE files provide this information in an easy-to-work-with way.</p>
<p>For now, Policeman builds the current and the previous versions of your package to generate <code>.hie</code> files. But we hope that the process of automatically creating GHC-generated IDE information will become more common and those files will be available immediately for processing. And we are looking forward to helping this feature become more popular.</p>
<h2 id="case-closed">Case closed<a href="#case-closed" class="anchor">🔗</a></h2>
<p>In the end, we want to add a few words about the Hackathon experience generally. A dedicated hackathon is a wonderful place to focus on something that you wanted to build for quite a long time. We managed to finalise the idea, create a plan for work and finish working MVP at this event. Quite productive!</p>
<p>As a pleasant bonus, you get to see a lot of people sharing your ideas and debate on decisions, tasks, and overall Haskell. So do try to get to one of such events. Hope to see you on the following Haskell Hackathons, cheers!</p>
              </p>
              </div>
            </div>

          </div>
      </div>
<footer class="footer text-center">
  <div class="row">
    <div class="col-12 post-body">
      <hr class="star-light">
    </div>
  </div>
  <div class="row justify-content-center flex-row">
      <div class="col-md-4 mb-5 mb-lg-0">
          <div class="stretch">
          <h4 class="text-uppercase mt-0 mb-4 flex-h">Support our work</h4>
          <p class="px-5 flex-text flex-txt">If you like what we do, you can help us do more of that by supporting on Ko-Fi or GitHub:</p>
          <ul class="empty-list list-inline mb-0 mx-auto flex-links">
              <li class="list-inline-item my-auto">
                  <a class="btn btn-outline-primary btn-sm rounded-pill" href="https://ko-fi.com/kowainik" target="_blank">
                      <i class="fas fa-coffee"></i> Buy a coffee
                  </a>

              </li>
              <li class="list-inline-item my-auto">
                  <a class="btn btn-outline-primary btn-sm rounded-pill" href="https://github.com/sponsors/vrom911" target="_blank">
                      <i class="fab fa-github"></i> @vrom911
                  </a>
              </li>
              <li class="list-inline-item my-auto">
                  <a class="btn btn-outline-primary btn-sm rounded-pill" href="https://github.com/sponsors/chshersh" target="_blank">
                      <i class="fab fa-github"></i> @chshersh
                  </a>
              </li>
          </ul>
        </div>
      </div>

      <div class="col-md-4 mb-5 mb-lg-0">
          <div class="stretch">
              <h4 class="text-uppercase text-center mb-4 footer-h">Subscribe</h4>
              <p class="px-5 flex-text footer-txt">Enjoyed this post? Consider subscribing to our newsletter to always be first to check out our new updates:</p>
        <!-- Begin Mailchimp Signup Form -->
              <div class="footer-links"> <div class="row justify-content-center subscribe-form" id="mc_embed_signup">
  <form action="https://news.us2.list-manage.com/subscribe/post?u=af5d0411175f11e83618abf5e&amp;id=b04a7ed805" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div class="form-row mx-0" id="mc_embed_signup_scroll">
      <div class="col-8 input-group ">
        <div class="input-group-prepend">
          <div class="input-group-text"><i class="fa fa-envelope"></i> </div>
        </div>
        <input type="email" value name="EMAIL" class="required email form-control" placeholder="Your email" id="mce-EMAIL">
      </div>
      <div class="col-4 text-left">
        <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button btn btn-primary btn-lg">
      </div>
      <div class="mc-field-group group-checkbox input-group">
        <ul>
          <li><input type="checkbox" value="1" name="group[83780][1]" class="form-check-input" id="mce-group[83780]-83780-0"></li>
          <li><input type="checkbox" value="2" name="group[83780][2]" class="form-check-input" id="mce-group[83780]-83780-1" checked></li>
        </ul>
      </div>
      <div id="mce-responses" class="clear">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
      </div>
      <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_af5d0411175f11e83618abf5e_b04a7ed805" tabindex="-1" value></div>
    </div>
  </form>
</div>
</div>
    <!--End mc_embed_signup-->
          </div>
    </div>
    <div class="col-md-4 mb-5 mb-lg-0">
        <div class="stretch">
        <h4 class="text-uppercase mb-4 footer-h">Follow us</h4>
        <p class="px-5 footer-txt mt-6">We also share our work elsewhere. You can find us also at:</p>
        <ul class="empty-list list-inline mb-0 mx-auto text-center footer-links">
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://twitter.com/kowainik" target="_blank">
                    <i class="fab fa-fw fa-twitter"></i>
                </a>
            </li>
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://github.com/kowainik" target="_blank">
                    <i class="fab fa-fw fa-github"></i>
                </a>
            </li>
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://www.linkedin.com/company/kowainik" target="_blank">
                    <i class="fab fa-fw fa-linkedin"></i>
                </a>
            </li>
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://t.me/kowainik" target="_blank">
                    <i class="fab fa-fw fa-telegram"></i>
                </a>
            </li>
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="../rss.xml" target="_blank">
                    <i class="fas fa-fw fa-rss"></i>
                </a>
            </li>
            
        </ul>
        </div>
    </div>
  </div>
</footer>


      <!-- Bootstrap core JavaScript -->
      <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"> </script>
      <script src="../js/post.js"> </script>
      <script src="../js/hide.js"> </script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
      <script>hljs.initHighlightingOnLoad()</script>
      <script async defer src="https://buttons.github.io/buttons.js"></script>
  </body>
</html>
