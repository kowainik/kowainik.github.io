<!DOCTYPE html>
<html lang="en">
  <head>
      <!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125893749-1"></script>
      <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-125893749-1');
          </script>
    <title>Haskell mini-patterns handbook :: Kowainik</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Kowainik ‚Äî Collection of small Haskell patterns with detailed description, examples and exercises">
    <meta name="keywords" content="Haskell, Functional progarmming, FP , haskell, tutorial, patterns ">
    <meta name="author" content="Kowainik  ‚Äî Dmitrii Kovanikov <> Veronika Romashkina " />

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@kowainik" />
    <meta property="twitter:title" content="Kowainik - Haskell mini-patterns handbook" />
    <meta name="twitter:description" content="Collection of small Haskell patterns with detailed description, examples and exercises" />
    <meta name="twitter:image:src" content="https://kowainik.github.io/images/logo-yellow.png" />
    <meta property="og:title" content="Kowainik - Haskell mini-patterns handbook" />
    <meta property="og:description" content="Collection of small Haskell patterns with detailed description, examples and exercises" />
    <meta property="og:site_name" content="Kowainik" />
    <meta property="og:image" content="https://kowainik.github.io/images/logo-yellow.png" />

    <!-- Favicon -->
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/dracula.min.css" />
    <!-- Fontawesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <!-- Custom fonts for this template -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato" />
    <!-- Custom styles for this template -->
    <link href="../css/default.css" rel="stylesheet">
    <link href="../css/post.css" rel="stylesheet">
  </head>

  <body class="body-posts">

          <!-- Header -->
      <nav class="navbar navbar-inverse navbar-fixed-left leftmenu bg-primary text-secondary">
            <div class="navbar-header text-center">
                <div class="postslogo justify-content-center"> <a href="../"><img class="img-fluid" src="../images/logo-tr.png" alt="Kowainik"></a></div>
                <div class="coffee text-center">
                    <a class="btn btn-primary rounded-pill" href="https://ko-fi.com/kowainik" target="_blank">
                        <i class="fas fa-coffee"></i> Buy a coffee
                    </a>
                </div>
                <ul class="socials empty-list list-inline mb-0 justify-content-center text-center mx-auto">
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="https://twitter.com/kowainik" target="_blank">
                        <i class="fab fa-fw fa-twitter"></i>
                    </a>
                </li>
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="https://github.com/kowainik" target="_blank">
                        <i class="fab fa-fw fa-github"></i>
                    </a>
                </li>
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="https://www.linkedin.com/company/kowainik" target="_blank">
                        <i class="fab fa-fw fa-linkedin"></i>
                    </a>
                </li>
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="https://t.me/kowainik" target="_blank">
                        <i class="fab fa-fw fa-telegram"></i>
                    </a>
                </li>
                
                <li class="list-inline-item my-auto">
                    <a class="btn btn-outline-dark btn-social text-center rounded-circle" href="../rss.xml" target="_blank">
                        <i class="fas fa-fw fa-rss"></i>
                    </a>
                </li>
                
                </ul>

            </div>

            <div class="toc-zone justify-content-center">
                <h6 class="coolFont">Contents</h6>
                <div class="toc" id="main">
                    <ul>
<li><a href="#newtype">Newtype</a>
<ul>
<li><a href="#newtype-task">Newtype: Task</a></li>
</ul></li>
<li><a href="#smart-constructor">Smart constructor</a>
<ul>
<li><a href="#smart-constructor-task">Smart constructor: Task</a></li>
</ul></li>
<li><a href="#evidence">Evidence</a>
<ul>
<li><a href="#evidence-task">Evidence: Task</a></li>
</ul></li>
<li><a href="#make-illegal-states-unrepresentable">Make illegal states unrepresentable</a>
<ul>
<li><a href="#make-illegal-states-unrepresentable-task-1">Make illegal states unrepresentable: Task 1</a></li>
<li><a href="#make-illegal-states-unrepresentable-task-2">Make illegal states unrepresentable: Task 2</a></li>
</ul></li>
<li><a href="#phantom-type-parameters">Phantom type parameters</a>
<ul>
<li><a href="#phantom-type-parameters-task">Phantom type parameters: Task</a></li>
</ul></li>
<li><a href="#monadfail-sugar">MonadFail sugar</a>
<ul>
<li><a href="#monadfail-sugar-task-1">MonadFail sugar: Task 1</a></li>
<li><a href="#monadfail-sugar-task-2">MonadFail sugar: Task 2</a></li>
<li><a href="#monadfail-sugar-task-3">MonadFail sugar: Task 3</a></li>
<li><a href="#monadfail-sugar-task-4">MonadFail sugar: Task 4</a></li>
</ul></li>
<li><a href="#polymorphisation">Polymorphisation</a>
<ul>
<li><a href="#polymorphisation-task-1">Polymorphisation: Task 1</a></li>
<li><a href="#polymorphisation-task-2">Polymorphisation: Task 2</a></li>
<li><a href="#polymorphisation-task-3">Polymorphisation: Task 3</a></li>
</ul></li>
<li><a href="#bidirectional-parsing">Bidirectional parsing</a>
<ul>
<li><a href="#bidirectional-parsing-task">Bidirectional parsing: Task</a></li>
</ul></li>
<li><a href="#recursive-go">Recursive go</a>
<ul>
<li><a href="#recursive-go-task-1">Recursive go: Task 1</a></li>
<li><a href="#recursive-go-task-2">Recursive go: Task 2</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
                </div>
            </div>
            <div class="allposts text-center">
                <h3><a href="../posts"> Posts =<< </a></h3>
            </div>
      </nav>
      <div class="container info">
          <h2 class="text-center text-uppercase text-secondary">Haskell mini-patterns handbook</h2>
          <div class="row coolFont align-self-center justify-content-center">
            <div class="col-10">Date: August 17, 2020</div>
            <div class="col-10">Updated: September 7, 2020</div>

            <div class="author col-10">Author: Dmitrii Kovanikov <> Veronika Romashkina</div>
            <div class="col-12 text-center m-auto tag-block">
                
                <span class="tag-block"> <a class="btn btn-outline-dark btn-tag" href="../tags/haskell">haskell</a></span>
                
                <span class="tag-block"> <a class="btn btn-outline-dark btn-tag" href="../tags/tutorial">tutorial</a></span>
                
                <span class="tag-block"> <a class="btn btn-outline-dark btn-tag" href="../tags/patterns">patterns</a></span>
                
            </div>
          </div>

          <div class="content">
            <div class="row post">
              <div class="col-12 post-body">
              <p class="lead">
                  <p>Navigating in the ocean of Haskell possibilities is challenging even though Haskell is a powerful language that helps to implement robust and maintainable programs. The language supplies you with tons of awesome approaches, but it is not always trivial to see how and where to use them properly.</p>
<p>Fortunately, like any other mainstream programming language, Haskell also has its best-practices and recommended ways for producing high-quality code. Knowing Haskell programming patterns helps you create better libraries and applications and make their users more pleased. And, yes, Haskell actually has FP-oriented programming patterns in addition to the best-practices shared with other languages.</p>
<p>If you are aware of the best ways to solve common problems, you can become a better Haskell developer by using more efficient programming techniques specific to the language. Likewise, you can apply Haskell-specific patterns successfully outside of Haskell.</p>
<p>This blog post contains a structured collection of some programming mini-patterns in Haskell with the detailed description and examples, some small ‚Äúquality of life‚Äù improvements that would help everyone on their developer journey.</p>
<div class="exercise">
<p>üìö In this article, each pattern contains at least one task with the hidden solution, so you can test your understanding of a pattern by solving the proposed task.</p>
</div>
<h2 id="newtype">Newtype<a href="#newtype" class="anchor">üîó</a></h2>
<div class="pattern row">
<div class="pattern-header bg-primary col-3">
Pattern
</div>
<div class="pattern-body col-9">
<p>Newtype</p>
</div>
<div class="pattern-header bg-primary col-3">
Description
</div>
<div class="pattern-body col-9">
<p>Lightweight data wrapper.</p>
</div>
<div class="pattern-header bg-primary col-3">
When to use
</div>
<div class="pattern-body col-9">
<p>When using the same primitive type (<code>Int</code>, <code>Text</code>, etc.) to represent semantically different entities (name, title, description, etc.).</p>
</div>
<div class="pattern-header bg-primary col-3">
Benefits
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Improves maintainability.</li>
<li>Increases code readability.</li>
<li>Enables writing custom instances.</li>
<li>Allows reusing instance definitions with <a href="https://downloads.haskell.org/ghc/latest/docs/html/users_guide/glasgow_exts.html#deriving-via">DerivingVia</a>.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Costs
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Additional wrapping and unwrapping.</li>
<li>Deriving boilerplate is required to duplicate existing behaviour of the underlying type.</li>
</ol>
</div>
</div>
<p>One of the most common and useful Haskell features is <code>newtype</code>. <code>newtype</code> is an ordinary data type with the name and a constructor. However, you can define a data type as <code>newtype</code> instead of <code>data</code> only if it has <strong>exactly</strong> one constructor with <strong>exactly</strong> one field.</p>
<p>It is extremely easy to define a <code>newtype</code> in Haskell as no extra effort is required from the user compared to the data type declaration. For example, the following are the valid <code>newtype</code> definitions:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co">-- + Valid definition of a wrapper around Double</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Volume</span> <span class="ot">=</span> <span class="dt">Volume</span> <span class="dt">Double</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="co">-- + Also valid newtype definition with the record field</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Size</span> <span class="ot">=</span> <span class="dt">Size</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>    {<span class="ot"> unSize ::</span> <span class="dt">Int</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>    }</span></code></pre></div>
<p>But you can‚Äôt declare the following data types as a <code>newtype</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co">-- - Invalid newtype definition: more than 1 field</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Point</span> <span class="ot">=</span> <span class="dt">Point</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>    {<span class="ot"> pointX ::</span> <span class="dt">Int</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>    ,<span class="ot"> pointY ::</span> <span class="dt">Int</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    }</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="co">-- - Ivalid newtype definition: more than 1 constructor</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Shape</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>    <span class="ot">=</span> <span class="dt">Circle</span> <span class="dt">Double</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Square</span> <span class="dt">Double</span></span></code></pre></div>
<p><code>newtype</code>s have a lot of great benefits but I‚Äôm going to focus only on the <em>code maintainability</em> in this section.</p>
<p>You can think of a <code>newtype</code> as a lightweight data type. Newtype has the same representation in memory as the wrapped type. Wrapping and unwrapping are also free operations in runtime. So, <code>newtype</code> is a <strong>zero-cost</strong> abstraction.</p>
<p>Notwithstanding from the compiler point of view, different <code>newtype</code>s are different data types. And since they don‚Äôt have any runtime overhead compared to the ordinary data types, you can provide a safer interface to your API without sacrificing performance.</p>
<p>Shall we look at the example now. Consider, that you have a function which takes a password, a hash and verifies whether the given hash is the hash of the given password. Since both password and hash are merely textual data, we could write the following function:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ot">validateHash ::</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span></code></pre></div>
<p>The problem with this function is that you can easily pass arguments in a different order and get faulty results. And you need to think about proper order of arguments each time you are calling this function. Should it be <code>validateHash password hash</code> or <code>validateHash hash password</code>? This approach is error-prone.</p>
<p>But if you define the following <code>newtype</code>s instead:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Password</span> <span class="ot">=</span> <span class="dt">Password</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    {<span class="ot"> unPassword ::</span> <span class="dt">ByteString</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    }</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">PasswordHash</span> <span class="ot">=</span> <span class="dt">PasswordHash</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>    {<span class="ot"> unPasswordHash ::</span> <span class="dt">ByteString</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>    }</span></code></pre></div>
<p>You can implement a more type-safe version of the <code>validateHash</code> function, and additionally this improves the code readability:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="ot">validateHash ::</span> <span class="dt">Password</span> <span class="ot">-&gt;</span> <span class="dt">PasswordHash</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span></code></pre></div>
<p>Now, <code>validateHash hash password</code> is a compile-time error, and it makes it impossible to confuse the order of arguments.</p>
<hr>
<p>Another popular way of increasing code readability without sacrificing performance is introducing a new alias (which is simply another name for a data type) by using the <code>type</code> keyword. Unfortunately, this approach is only a partial solution since it helps only a developer, not the compiler as the compiler doesn‚Äôt see the difference between type alias and type itself. And if you don‚Äôt help your compiler, the compiler won‚Äôt be there for you when you need it.</p>
<p>For example, the following code is flawed:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Attack</span>  <span class="ot">=</span> <span class="dt">Int</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Defense</span> <span class="ot">=</span> <span class="dt">Int</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="ot">calculateDamage ::</span> <span class="dt">Attack</span> <span class="ot">-&gt;</span> <span class="dt">Defense</span> <span class="ot">-&gt;</span> <span class="dt">Attack</span></span></code></pre></div>
<p>Of course, the above type signature is better than <code>Int -&gt; Int -&gt; Int</code>, but the compiler sees it exactly like this. So, you still can write <code>calculateDamage monsterDefense playerAttack</code> and get a runtime bug.</p>
<p>The approach of using <code>type</code>s instead of <code>newtype</code> can bring even more damage when you have a lot of similar data types. The more types you have the harder to maintain them without external help. Below you can see a code sample from one of the Haskell libraries:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">WorkerId</span> <span class="ot">=</span> <span class="dt">UUID</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">SupervisorId</span> <span class="ot">=</span> <span class="dt">UUID</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">ProcessId</span> <span class="ot">=</span> <span class="dt">UUID</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">ProcessName</span> <span class="ot">=</span> <span class="dt">Text</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">SupervisorName</span> <span class="ot">=</span> <span class="dt">Text</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">WorkerName</span> <span class="ot">=</span> <span class="dt">Text</span></span></code></pre></div>
<p>The library safety can be improved by replacing all these type aliases with <code>newtype</code>s, and it can even help to discover some bugs that happen due to passing arguments in the wrong order.</p>
<p>Moreover, the <code>newtype</code> approach is more flexible since you can provide your custom instances or restrict some instances allowing you to create values in an unsafe way.</p>
<p>The cost of using <code>newtype</code> is small ‚Äî you only need to wrap and unwrap it when necessary. But the benefits hugely outweigh this small price.</p>
<section id="newtype-task" class="exercise">
<h3>Newtype: Task<a href="#newtype-task" class="anchor">üîó</a></h3>
<p>Improve the following code by applying the <strong>Newtype</strong> pattern.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Player</span> <span class="ot">=</span> <span class="dt">Player</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>    {<span class="ot"> playerHealth    ::</span> <span class="dt">Int</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>    ,<span class="ot"> playerArmor     ::</span> <span class="dt">Int</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>    ,<span class="ot"> playerAttack    ::</span> <span class="dt">Int</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>    ,<span class="ot"> playerDexterity ::</span> <span class="dt">Int</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>    ,<span class="ot"> playerStrength  ::</span> <span class="dt">Int</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>    }</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a><span class="ot">calculatePlayerDamage ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>calculatePlayerDamage attack strength <span class="ot">=</span> attack <span class="op">+</span> strength</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a><span class="ot">calculatePlayerDefense ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a>calculatePlayerDefense armor dexterity <span class="ot">=</span> armor <span class="op">*</span> dexterity</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true"></a><span class="ot">calculateHit ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true"></a>calculateHit damage defense health <span class="ot">=</span> health <span class="op">+</span> defense <span class="op">-</span> damage</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true"></a><span class="co">-- The second player hits first player and the new first player is returned</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true"></a><span class="ot">hitPlayer ::</span> <span class="dt">Player</span> <span class="ot">-&gt;</span> <span class="dt">Player</span> <span class="ot">-&gt;</span> <span class="dt">Player</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true"></a>hitPlayer player1 player2 <span class="ot">=</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true"></a>    <span class="kw">let</span> damage <span class="ot">=</span> calculatePlayerDamage</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true"></a>            (playerAttack player2)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true"></a>            (playerStrength player2)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true"></a>        defense <span class="ot">=</span> calculatePlayerDefense</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true"></a>            (playerArmor player1)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true"></a>            (playerDexterity player1)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true"></a>        newHealth <span class="ot">=</span> calculateHit</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true"></a>            damage</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true"></a>            defense</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true"></a>            (playerHealth player1)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true"></a>    <span class="kw">in</span> player1 { playerHealth <span class="ot">=</span> newHealth }</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionNewtype1" aria-expanded="false" aria-controls="solutionNewtype1">
Show solution
</button>
<div id="solutionNewtype1" class="solution collapse">
<h4 id="newtype-solution-1">Newtype: Solution 1<a href="#newtype-solution-1" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Health</span>    <span class="ot">=</span> <span class="dt">Health</span>    <span class="dt">Int</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Armor</span>     <span class="ot">=</span> <span class="dt">Armor</span>     <span class="dt">Int</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Attack</span>    <span class="ot">=</span> <span class="dt">Attack</span>    <span class="dt">Int</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Dexterity</span> <span class="ot">=</span> <span class="dt">Dexterity</span> <span class="dt">Int</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Strength</span>  <span class="ot">=</span> <span class="dt">Strength</span>  <span class="dt">Int</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Damage</span>    <span class="ot">=</span> <span class="dt">Damage</span>    <span class="dt">Int</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Defense</span>   <span class="ot">=</span> <span class="dt">Defense</span>   <span class="dt">Int</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Player</span> <span class="ot">=</span> <span class="dt">Player</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>    {<span class="ot"> playerHealth    ::</span> <span class="dt">Health</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>    ,<span class="ot"> playerArmor     ::</span> <span class="dt">Armor</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a>    ,<span class="ot"> playerAttack    ::</span> <span class="dt">Attack</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a>    ,<span class="ot"> playerDexterity ::</span> <span class="dt">Dexterity</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a>    ,<span class="ot"> playerStrength  ::</span> <span class="dt">Strength</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a>    }</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a><span class="ot">calculatePlayerDamage ::</span> <span class="dt">Attack</span> <span class="ot">-&gt;</span> <span class="dt">Strength</span> <span class="ot">-&gt;</span> <span class="dt">Damage</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a>calculatePlayerDamage (<span class="dt">Attack</span> attack) (<span class="dt">Strength</span> strength) <span class="ot">=</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a>    <span class="dt">Damage</span> (attack <span class="op">+</span> strength)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a><span class="ot">calculatePlayerDefense ::</span> <span class="dt">Armor</span> <span class="ot">-&gt;</span> <span class="dt">Dexterity</span> <span class="ot">-&gt;</span> <span class="dt">Defense</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a>calculatePlayerDefense (<span class="dt">Armor</span> armor) (<span class="dt">Dexterity</span> dexterity) <span class="ot">=</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true"></a>    <span class="dt">Defense</span> (armor <span class="op">*</span> dexterity)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true"></a><span class="ot">calculateHit ::</span> <span class="dt">Damage</span> <span class="ot">-&gt;</span> <span class="dt">Defense</span> <span class="ot">-&gt;</span> <span class="dt">Health</span> <span class="ot">-&gt;</span> <span class="dt">Health</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true"></a>calculateHit (<span class="dt">Damage</span> damage) (<span class="dt">Defense</span> defense) (<span class="dt">Health</span> health) <span class="ot">=</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true"></a>    <span class="dt">Health</span> (health <span class="op">+</span> defense <span class="op">-</span> damage)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true"></a><span class="co">-- The second player hits first player and the new first player is returned</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true"></a><span class="ot">hitPlayer ::</span> <span class="dt">Player</span> <span class="ot">-&gt;</span> <span class="dt">Player</span> <span class="ot">-&gt;</span> <span class="dt">Player</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true"></a>hitPlayer player1 player2 <span class="ot">=</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true"></a>    <span class="kw">let</span> damage <span class="ot">=</span> calculatePlayerDamage</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true"></a>            (playerAttack player2)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true"></a>            (playerStrength player2)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true"></a>        defense <span class="ot">=</span> calculatePlayerDefense</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true"></a>            (playerArmor player1)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true"></a>            (playerDexterity player1)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true"></a>        newHealth <span class="ot">=</span> calculateHit</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true"></a>            damage</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true"></a>            defense</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true"></a>            (playerHealth player1)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true"></a>    <span class="kw">in</span> player1 { playerHealth <span class="ot">=</span> newHealth }</span></code></pre></div>
<p>Notice how the implementation of the <code>hitPlayer</code> function hasn‚Äôt changed at all. However, if you try to swap some of the arguments in different functions now, the compiler will prevent you from accidentally committing an error.</p>
</div>
</section>
<h2 id="smart-constructor">Smart constructor<a href="#smart-constructor" class="anchor">üîó</a></h2>
<div class="pattern row">
<div class="pattern-header bg-primary col-3">
Pattern
</div>
<div class="pattern-body col-9">
<p>Smart constructor</p>
</div>
<div class="pattern-header bg-primary col-3">
Description
</div>
<div class="pattern-body col-9">
<p>Providing idiomatic ways for constructing values.</p>
</div>
<div class="pattern-header bg-primary col-3">
When to use
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>When a data type restricts some values (e.g.¬†not every <code>ByteString</code> is a valid <code>Password</code>).</li>
<li>When you want to make construction of big data types easier.</li>
<li>To avoid runtime errors.</li>
<li>To make illegal states unrepresentable.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Benefits
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>More structured and maintainable code.</li>
<li>Separation of concepts.</li>
<li>Control of erroneous data inputs.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Costs
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Some extra code.</li>
<li>Decide on the approach details.</li>
<li>Inability to define instances outside of the module.</li>
</ol>
</div>
</div>
<p>Once you have a <code>newtype</code>, first you need to create its value to work with it. And sometimes you want to validate a value before proceeding with it. Usually you would create a value of a data type by using its constructor. However, when programming in a modular way, you want to have boundaries in your interface and avoid providing unsafe ways of constructing values without validation.</p>
<p>This programming pattern in Haskell is called <strong>smart constructor</strong>. It can be understood better by looking at the implementation of such approach based on the <code>Password</code> data type:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Password</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>    ( <span class="dt">Password</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>    , unPassword</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>    , mkPassword</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>    ) <span class="kw">where</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.ByteString</span> (<span class="dt">ByteString</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString</span> <span class="kw">as</span> <span class="dt">ByteString</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Password</span> <span class="ot">=</span> <span class="dt">Password</span> <span class="dt">ByteString</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a><span class="ot">unPassword ::</span> <span class="dt">Password</span> <span class="ot">-&gt;</span> <span class="dt">ByteString</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a>unPassword (<span class="dt">Password</span> password) <span class="ot">=</span> password</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a><span class="co">-- | Smart constructor. Doesn't allow empty passwords.</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true"></a><span class="ot">mkPassword ::</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Password</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true"></a>mkPassword pwd</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">ByteString</span><span class="op">.</span><span class="fu">null</span> pwd <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true"></a>    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dt">Just</span> (<span class="dt">Password</span> pwd)</span></code></pre></div>
<p>In this module, we want to reject empty passwords. This is what the <code>mkPassword</code> function does. We disincline to export the <code>Password</code> constructor.</p>
<p>But we need a way to deconstruct a value of type <code>Password</code>. Unfortunately, we can‚Äôt define a record field of our <code>newtype</code> because it allows to change values using record update syntax. Hence the <code>unPassword</code> function.</p>
<blockquote>
<p>üë©‚Äçüî¨ It is important to hide the constructor to forbid <a href="http://hackage.haskell.org/package/base-4.14.0.0/docs/Data-Coerce.html">value coercion</a>.</p>
</blockquote>
<p>Even if you don‚Äôt allow creating unvalidated passwords, you may need to create passwords in your test-suite without extra hassle. So we could create a function <code>unsafePassword</code> with a hint in the name.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="co">-- | Used in testing.</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="ot">unsafePassword ::</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Password</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>unsafePassword <span class="ot">=</span> <span class="dt">Password</span></span></code></pre></div>
<p>If you notice usages of this function in your application code during code review, something is clearly wrong. Moreover, it is even possible to set up some automatic tooling to perform such checks for you.</p>
<hr>
<p>You can find multiple variations of this pattern in the wild that differ in some implementation details:</p>
<ul>
<li>Usage of <a href="https://downloads.haskell.org/ghc/latest/docs/html/users_guide/glasgow_exts.html#pattern-synonyms">PatternSynonyms</a></li>
<li>Replacing <code>Maybe</code> with <a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Data-Either.html">Either</a> or <a href="http://hackage.haskell.org/package/validation-selective-0.1.0.0/docs/Validation.html">Validation</a> types for better error-reporting</li>
<li>Rename the constructor to <code>UnsafePassword</code> instead of having a separate <code>unsafePassword</code> function (however, this is a less safer approach due to coercions)</li>
<li>Validation of the statically-known values during compile-time, so you get errors in compile-time instead of runtime, and you don‚Äôt need unsafe functions when you know that the values are valid</li>
<li>Others</li>
</ul>
<p>Unfortunately, the community has not reached the consensus on what is the only true way to implement smart constructors. All ways slightly differ in ergonomics and naming schemes, they all do their job and fit various use cases of different systems. But the general idea remains the same across all approaches.</p>
<section id="smart-constructor-task" class="exercise">
<h3>Smart constructor: Task<a href="#smart-constructor-task" class="anchor">üîó</a></h3>
<p>Improve the following code by applying the <strong>Smart constructor</strong> pattern.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Tag</span> <span class="kw">where</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="co">-- | Tag is a non-empty string.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Tag</span> <span class="ot">=</span> <span class="dt">Tag</span> <span class="dt">String</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a><span class="ot">mkTag ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Tag</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>mkTag tag</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>    <span class="op">|</span> <span class="fu">null</span> tag <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Empty tag!&quot;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dt">Tag</span> tag</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">TagsList</span> <span class="kw">where</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.List.NonEmpty</span> (<span class="dt">NonEmpty</span> (..))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Tag</span> (<span class="dt">Tag</span>, mkTag)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a><span class="co">-- | Non-empty list of non-empty tags.</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">TagsList</span> <span class="ot">=</span> <span class="dt">TagsList</span> (<span class="dt">NonEmpty</span> <span class="dt">Tag</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a><span class="ot">mkTagsList ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">TagsList</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a>mkTagsList [] <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Empty list of tags&quot;</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>mkTagsList (tag<span class="op">:</span>tags) <span class="ot">=</span> <span class="dt">TagsList</span> <span class="op">$</span> mkTag tag <span class="op">:|</span> <span class="fu">map</span> mkTag tags</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionSmartConstructor1" aria-expanded="false" aria-controls="solutioncSmartConstructor1">
Show solution
</button>
<div id="solutionSmartConstructor1" class="solution collapse">
<h4 id="smart-constructor-solution">Smart constructor: Solution<a href="#smart-constructor-solution" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Tag</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>    ( <span class="dt">Tag</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>    , unTag</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>    , mkTag</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>    ) <span class="kw">where</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a><span class="co">-- | Tag is a non-empty string.</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Tag</span> <span class="ot">=</span> <span class="dt">Tag</span> <span class="dt">String</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a><span class="ot">unTag ::</span> <span class="dt">Tag</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>unTag (<span class="dt">Tag</span> tag) <span class="ot">=</span> tag</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a><span class="ot">mkTag ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Tag</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true"></a>mkTag tag</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true"></a>    <span class="op">|</span> <span class="fu">null</span> tag <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true"></a>    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dt">Just</span> (<span class="dt">Tag</span> tag)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">TagsList</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a>    ( <span class="dt">TagsList</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>    , unTagsList</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>    , mkTagsList</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a>    ) <span class="kw">where</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Control.Applicative</span> (liftA2)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.List.NonEmpty</span> (<span class="dt">NonEmpty</span> (..))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Tag</span> (<span class="dt">Tag</span>, mkTag)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true"></a><span class="co">-- | Non-empty list of non-empty tags.</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">TagsList</span> <span class="ot">=</span> <span class="dt">TagsList</span> (<span class="dt">NonEmpty</span> <span class="dt">Tag</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true"></a><span class="ot">unTagsList ::</span> <span class="dt">TagsList</span> <span class="ot">-&gt;</span> <span class="dt">NonEmpty</span> <span class="dt">Tag</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true"></a>unTagsList (<span class="dt">TagsList</span> tagsList) <span class="ot">=</span> tagsList</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true"></a><span class="ot">mkTagsList ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">TagsList</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true"></a>mkTagsList [] <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true"></a>mkTagsList (tag<span class="op">:</span>tags) <span class="ot">=</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true"></a>    <span class="dt">TagsList</span> <span class="op">&lt;$&gt;</span> liftA2 (<span class="op">:|</span>) (mkTag tag) (<span class="fu">traverse</span> mkTag tags)</span></code></pre></div>
</div>
</section>
<h2 id="evidence">Evidence<a href="#evidence" class="anchor">üîó</a></h2>
<div class="pattern row">
<div class="pattern-header bg-primary col-3">
Pattern
</div>
<div class="pattern-body col-9">
<p>Evidence</p>
</div>
<div class="pattern-header bg-primary col-3">
Description
</div>
<div class="pattern-body col-9">
<p>Replacing boolean blindness with the validation witness.</p>
</div>
<div class="pattern-header bg-primary col-3">
When to use
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Always. But most importantly, when you want to make sure that data is validated or you want to reuse that knowledge in the future.</li>
<li>To make illegal states unrepresentable.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Benefits
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>More robust code.</li>
<li>Better maintainability (e.g.¬†easier to refactor).</li>
<li>More context in data.</li>
<li>Better error-messages support.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Costs
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Requires writing code in a slightly different way.</li>
<li>More code.</li>
</ol>
</div>
</div>
<p>This topic naturally completes the previous pattern of ‚ÄúSmart constructors‚Äù. The approach was covered before in various excellent blog posts:</p>
<ul>
<li><a href="https://cs-syd.eu/posts/2016-07-24-overcoming-boolean-blindness-evidence.html">Overcoming Boolean blindness with Evidence</a></li>
<li><a href="https://runtimeverification.com/blog/code-smell-boolean-blindness/">Code smell: Boolean blindness</a></li>
<li><a href="https://lexi-lambda.github.io/blog/2019/11/05/parse-don-t-validate/">Parse, don‚Äôt validate</a></li>
</ul>
<p>All above posts provide an amazing description and explanation of the <strong>Evidence</strong> pattern. Here we would like to add only a short overview with a small example.</p>
<p>For our example, let‚Äôs have a look at the function that sorts a list. Its type in Haskell looks like this:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="fu">sort</span><span class="ot"> ::</span> <span class="dt">Ord</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> [a]</span></code></pre></div>
<p>By sorting a list, we gained a knowledge that now all elements in the list are in the increasing (or decreasing) order. But the type of a sorted list is the same as the type of any other list. So there is no way to know in advance, whether a list is sorted or not.</p>
<p>Fortunately, this problem can be solved. We are going to follow <a href="#newtype">Newtype</a> and <a href="#smart-constructor">Smart constructor</a> patterns:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">SortedList</span> a <span class="ot">=</span> <span class="dt">SortedList</span> [a]</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a><span class="fu">sort</span><span class="ot"> ::</span> <span class="dt">Ord</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">SortedList</span> a</span></code></pre></div>
<blockquote>
<p>üë©‚Äçüî¨ It is possible to use more sophisticated techniques (such as dependent types) to ensure that the list is sorted by construction, but this approach has its own pros and cons.</p>
</blockquote>
<p>By wrapping the list into the newtype we record (and can provide later) an <em>evidence</em> of the list elements order. It may be important to have this knowledge, because if you know that the list is sorted, you can implement some functions more <strong>efficiently</strong> than for the ordinary lists, e.g.:</p>
<ol type="1">
<li><p>Find the minimum of a list.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="fu">minimum</span><span class="ot"> ::</span> <span class="dt">SortedList</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</span></code></pre></div></li>
<li><p>Keep only unique elements in the list.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="ot">nub ::</span> <span class="dt">Eq</span> a <span class="ot">=&gt;</span> <span class="dt">SortedList</span> a <span class="ot">-&gt;</span> <span class="dt">SortedList</span> a</span></code></pre></div></li>
<li><p>Merge two sorted list into a new sorted list.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="ot">merge ::</span> <span class="dt">Ord</span> a <span class="ot">=&gt;</span> <span class="dt">SortedList</span> a <span class="ot">-&gt;</span> <span class="dt">SortedList</span> a <span class="ot">-&gt;</span> <span class="dt">SortedList</span> a</span></code></pre></div></li>
</ol>
<hr>
<p>Unfortunately, even if you follow the <strong>Evidence</strong> pattern in types, you still can misuse it in values. Consider the following code that throws away the knowledge about given evidence:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="ot">add ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>add f g x <span class="ot">=</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>    <span class="kw">if</span> isNothing (f x) <span class="op">||</span> isNothing (g x)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a>    <span class="kw">then</span> <span class="dt">Nothing</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a>    <span class="kw">else</span> <span class="dt">Just</span> (fromJust (f x) <span class="op">+</span> fromJust (g x))</span></code></pre></div>
<p>Writing such code is a sign that you are following the boolean blindness anti-pattern and it is time to refactor your code immediately.</p>
<p>The key issue here is that by calling a function that returns <code>Bool</code> you lose the information about earlier performed validation. Instead, you can keep this information by explicitly pattern-matching on the validation or result.</p>
<div class="exercise">
<p>üìö <strong>Exercise:</strong> Try refactoring the above code without using <code>isNothing</code> and <code>fromJust</code> functions. Bonus points for using <code>Maybe</code> as a <code>Monad</code>.</p>
</div>
<p>Returning to our previous example with the <code>validateHash</code> function:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="ot">validateHash ::</span> <span class="dt">Password</span> <span class="ot">-&gt;</span> <span class="dt">PasswordHash</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span></code></pre></div>
<p>You still can forget to call this validation function in the application code and allow users to work with invalid passwords.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a>getUserPage,<span class="ot"> accessDenied ::</span> <span class="dt">User</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Page</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a><span class="ot">loginUser ::</span> <span class="dt">User</span> <span class="ot">-&gt;</span> <span class="dt">Password</span> <span class="ot">-&gt;</span> <span class="dt">PasswordHash</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Page</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a>loginUser user pwd pwdHash <span class="ot">=</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a>    <span class="kw">if</span> validateHash pwd pwdHash</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a>    <span class="kw">then</span> getUserPage user</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true"></a>    <span class="kw">else</span> accessDenied user</span></code></pre></div>
<p>The above code has two problems:</p>
<ol type="1">
<li>Even in the <code>else</code> branch you can call <code>getUserPage</code> and allow users to enter with the invalid passwords.</li>
<li>You can simply forget to call <code>validateHash</code> whenever it is needed.</li>
</ol>
<p>One more type-safe approach (but also a bit more heavyweight solution) would be to return some sort of witness for the fact that a password was validated, and then require this witness in the future functions.</p>
<p>To implement this solution, first, we need to change the type of <code>validateHash</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="co">-- opaque data type that can be created using only 'validateHash'</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">UserAuth</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a><span class="co">-- Instead of returning 'Bool' we return 'UserAuth'</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a><span class="ot">validateHash ::</span> <span class="dt">Password</span> <span class="ot">-&gt;</span> <span class="dt">PasswordHash</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">UserAuth</span></span></code></pre></div>
<p>Now we change the type of <code>getUserPage</code> to take <code>UserAuth</code> as a required parameter:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="ot">getUserPage ::</span> <span class="dt">UserAuth</span> <span class="ot">-&gt;</span> <span class="dt">User</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Page</span></span></code></pre></div>
<p>Since <code>UserAuth</code> can be created only with <code>validateHash</code>, the only way to return a user page is by performing password validation:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="ot">loginUser ::</span> <span class="dt">User</span> <span class="ot">-&gt;</span> <span class="dt">Password</span> <span class="ot">-&gt;</span> <span class="dt">PasswordHash</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Page</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>loginUser user pwd pwdHash <span class="ot">=</span> <span class="kw">case</span> validateHash pwd pwdHash <span class="kw">of</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>    <span class="dt">Nothing</span>   <span class="ot">-&gt;</span> accessDenied user</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>    <span class="dt">Just</span> auth <span class="ot">-&gt;</span> getUserPage auth user</span></code></pre></div>
<p>You can see how we made the code safer and more robust by a small change. And, as always, there are multiple ways of solving this problem including usages of more advanced Haskell features for providing better guarantees, with better ergonomics or for solving more difficult problems. For example, the following blog post describes implementation of a similar problem using more advanced Haskell features:</p>
<ul>
<li><a href="https://serokell.io/blog/haskell-type-level-witness">Type Witness in Haskell</a></li>
</ul>
<section id="evidence-task" class="exercise">
<h3>Evidence: Task<a href="#evidence-task" class="anchor">üîó</a></h3>
<p>Improve the following code by applying the <strong>Evidence</strong> pattern.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.IntMap</span> (<span class="dt">IntMap</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (fromJust)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.IntMap</span> <span class="kw">as</span> <span class="dt">IntMap</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a>getNearestValues</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">IntMap</span> <span class="dt">Double</span>  <span class="co">-- ^ Map from positions to values</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Int</span>            <span class="co">-- ^ Current position</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Double</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true"></a>getNearestValues vals pos</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true"></a>    <span class="co">-- both positions are in Map: returns sum of them</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true"></a>    <span class="op">|</span> IntMap.member (pos <span class="op">-</span> <span class="dv">1</span>) vals <span class="op">&amp;&amp;</span> IntMap.member (pos <span class="op">+</span> <span class="dv">1</span>) vals <span class="ot">=</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true"></a>        fromJust (IntMap.lookup (pos <span class="op">-</span> <span class="dv">1</span>) vals) <span class="op">+</span> fromJust (IntMap.lookup (pos <span class="op">+</span> <span class="dv">1</span>) vals)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true"></a>    <span class="co">-- only left position is in Map</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true"></a>    <span class="op">|</span> IntMap.member (pos <span class="op">-</span> <span class="dv">1</span>) vals <span class="ot">=</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true"></a>        fromJust (IntMap.lookup (pos <span class="op">-</span> <span class="dv">1</span>) vals)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true"></a>    <span class="co">-- only right position is in Map</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true"></a>    <span class="op">|</span> IntMap.member (pos <span class="op">+</span> <span class="dv">1</span>) vals <span class="ot">=</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true"></a>        fromJust (IntMap.lookup (pos <span class="op">+</span> <span class="dv">1</span>) vals)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true"></a>    <span class="co">-- no neighbours in map</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true"></a>    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="fl">0.0</span></span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionEvidence1" aria-expanded="false" aria-controls="solutionEvidence1">
Show solution
</button>
<div id="solutionEvidence1" class="solution collapse">
<h4 id="evidence-solution">Evidence: Solution<a href="#evidence-solution" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.IntMap</span> (<span class="dt">IntMap</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.IntMap</span> <span class="kw">as</span> <span class="dt">IntMap</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true"></a>getNearestValues</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">IntMap</span> <span class="dt">Double</span>  <span class="co">-- ^ Map from positions to values</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Int</span>            <span class="co">-- ^ Current position</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Double</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true"></a>getNearestValues vals pos <span class="ot">=</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true"></a>    <span class="kw">case</span> (IntMap.lookup (pos <span class="op">-</span> <span class="dv">1</span>) vals, IntMap.lookup (pos <span class="op">+</span> <span class="dv">1</span>) vals) <span class="kw">of</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true"></a>        (<span class="dt">Just</span> left, <span class="dt">Just</span> right) <span class="ot">-&gt;</span> left <span class="op">+</span> right</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true"></a>        (<span class="dt">Just</span> left, <span class="dt">Nothing</span>)    <span class="ot">-&gt;</span> left</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true"></a>        (<span class="dt">Nothing</span>, <span class="dt">Just</span> right)   <span class="ot">-&gt;</span> right</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true"></a>        (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>)      <span class="ot">-&gt;</span> <span class="fl">0.0</span></span></code></pre></div>
</div>
</section>
<h2 id="make-illegal-states-unrepresentable">Make illegal states unrepresentable<a href="#make-illegal-states-unrepresentable" class="anchor">üîó</a></h2>
<div class="pattern row">
<div class="pattern-header bg-primary col-3">
Pattern
</div>
<div class="pattern-body col-9">
<p>Make illegal states unrepresentable</p>
</div>
<div class="pattern-header bg-primary col-3">
Description
</div>
<div class="pattern-body col-9">
<p>Data types precisely describe the domain allowing to create all valid values and making it impossible to construct invalid values.</p>
</div>
<div class="pattern-header bg-primary col-3">
When to use
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>To restrict domain of possible values.</li>
<li>When it is feasible to describe the domain precisely.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Benefits
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Correctness.</li>
<li>Need to write fewer tests.</li>
<li>Harder to introduce bugs for people not knowing the whole context of a big picture.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Costs
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>May require writing custom helper data types and functions.</li>
<li>Code can increase in size.</li>
<li>Harder to introduce logic changes.</li>
</ol>
</div>
</div>
<p>This pattern is closely related to <a href="#smart-constructor">smart constructor</a> and <a href="#evidence">evidence</a> patterns, and they can and should be used together.</p>
<p>The <em>make illegal states unrepresentable</em> motto is well-known in the FP community. Functional Programming features such as Algebraic Data Types (ADT), parametric polymorphism and others allow describing the shape of the valid data more precisely to the extent that it is impossible to construct any invalid values.</p>
<p>To give a simple example of this idea, consider a function that takes two optional values and does something with those values, but only when both values are present. The function assumes that you won‚Äôt pass only a single value without the second element, so it doesn‚Äôt bother to handle such cases.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a><span class="ot">handleTwoOptionals ::</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a>handleTwoOptionals (<span class="dt">Just</span> a) (<span class="dt">Just</span> b) <span class="ot">=</span> <span class="op">...</span> work with <span class="ch">'a'</span> <span class="fu">and</span> <span class="ch">'b'</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true"></a>handleTwoOptionals <span class="dt">Nothing</span> <span class="dt">Nothing</span> <span class="ot">=</span> <span class="op">...</span> proceed without values</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true"></a>handleTwoOptionals _ _ <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;You must specify both values&quot;</span></span></code></pre></div>
<p>The type of <code>handleTwoOptionals</code> allows passing <code>Just a</code> and <code>Nothing :: Maybe b</code>, but in reality the function doesn‚Äôt process such a combination. You can notice that it is straightforward to fix this particular problem by changing types barely: instead of passing two <code>Maybe</code>s separately, you need to pass <code>Maybe</code> of a pair.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a><span class="ot">handleTwoOptionals ::</span> <span class="dt">Maybe</span> (a, b) <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a>handleTwoOptionals (<span class="dt">Just</span> (a, b)) <span class="ot">=</span> <span class="op">...</span> work with <span class="ch">'a'</span> <span class="fu">and</span> <span class="ch">'b'</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a>handleTwoOptionals <span class="dt">Nothing</span> <span class="ot">=</span> <span class="op">...</span> proceed without values</span></code></pre></div>
<p>With this slight change we made it impossible to specify only a single value as <code>Nothing</code>. If you pass <code>Just</code> of something, you must always provide both values.</p>
<hr>
<p>Let‚Äôs move on to another example. Now we want to write a function that takes two lists, but those lists must have the same length. Our function doesn‚Äôt work when lists have different sizes. The type signature can look like this:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a><span class="ot">processTwoLists ::</span> [a] <span class="ot">-&gt;</span> [b] <span class="ot">-&gt;</span> <span class="dt">Int</span></span></code></pre></div>
<p>It is up to the caller to verify that both lists have the same size. But if you don‚Äôt verify list lengths, the <code>processTwoLists</code> function fails. Moreover, even if a caller checked this property, the type signature still doesn‚Äôt capture the verification result. Note, that it could benefit from the usage of the <a href="#evidence">evidence</a> pattern to bear in mind this fact.</p>
<p>Again, it is pretty easy to fix the problem by changing the type of <code>processTwoLists</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a><span class="ot">processTwoLists ::</span> [(a, b)] <span class="ot">-&gt;</span> <span class="dt">Int</span></span></code></pre></div>
<p>Instead of passing two lists and expecting them to have the same size, the function simply takes a list of pairs, so it has the same number of <code>a</code>s and <code>b</code>s.</p>
<hr>
<p>And one more example. Imagine, that you are writing a web application with the backend and frontend. And you have a function that deals with the settings for both backend and frontend to launch your app. Both setting configurations can be optional, but at least one of the settings parts should be specified.</p>
<p>You can start approaching this problem by writing the following code:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Settings</span> <span class="ot">=</span> <span class="dt">Settings</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true"></a>    {<span class="ot"> settingsBackend  ::</span> <span class="dt">Maybe</span> <span class="dt">BackendSettings</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true"></a>    ,<span class="ot"> settingsFrontend ::</span> <span class="dt">Maybe</span> <span class="dt">FrontendSettings</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true"></a>    }</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true"></a><span class="ot">runApp ::</span> <span class="dt">Settings</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true"></a>runApp <span class="dt">Settings</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">case</span> (settingsBackend, settingsFrontend) <span class="kw">of</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true"></a>    (<span class="dt">Just</span> back, <span class="dt">Just</span> front) <span class="ot">-&gt;</span> configureBack back <span class="op">&gt;&gt;</span> configureFront front <span class="op">&gt;&gt;</span> run</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true"></a>    (<span class="dt">Just</span> back, <span class="dt">Nothing</span>)    <span class="ot">-&gt;</span> configureBack back <span class="op">&gt;&gt;</span> run</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true"></a>    (<span class="dt">Nothing</span>, <span class="dt">Just</span> front)   <span class="ot">-&gt;</span> configureFront front <span class="op">&gt;&gt;</span> run</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true"></a>    (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>)      <span class="ot">-&gt;</span> throw <span class="st">&quot;You must specify at least one settings&quot;</span></span></code></pre></div>
<p>But the above function has the same problem: the data type makes it possible to specify values that shouldn‚Äôt happen in real life. To fix this problem, we need to change the shape our <code>Settings</code> data type in the following way by using sum types:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Settings</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a>    <span class="ot">=</span> <span class="dt">OnlyBackend</span> <span class="dt">BackendSettings</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">OnlyFrontend</span> <span class="dt">FrontendSettings</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">BothSettings</span> <span class="dt">BackendSettings</span> <span class="dt">FrontendSettings</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true"></a><span class="ot">runApp ::</span> <span class="dt">Settings</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true"></a>runApp <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true"></a>    <span class="dt">OnlyBackend</span> back        <span class="ot">-&gt;</span> configureBack back <span class="op">&gt;&gt;</span> run</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true"></a>    <span class="dt">OnlyFrontend</span> front      <span class="ot">-&gt;</span> configureFront front <span class="op">&gt;&gt;</span> run</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true"></a>    <span class="dt">BothSettings</span> back front <span class="ot">-&gt;</span> configureBack back <span class="op">&gt;&gt;</span> configureFront front <span class="op">&gt;&gt;</span> run</span></code></pre></div>
<p>Now, even developers unfamiliar with the codebase won‚Äôt be able to create invalid settings. The shape of our data precisely describes all valid states in our program.</p>
<p>Generally, by pushing requirements for our data types upstream, we can implement more correct code and make the life of our API users easier, because they can‚Äôt shoot themselves in the foot by providing illegal values.</p>
<hr>
<p>However, it is not always possible to easily make all invalid states unrepresentable. Consider the following example. You have an enumeration type representing answers to some questions in a form. And users of this form must enter up to 3 different values in that form. Even if requirements explicitly tell that we must have one, two or three distinct answers, you might go with the a simple data type like this:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Answers</span> <span class="ot">=</span> <span class="dt">Answers</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true"></a>    {<span class="ot"> answers1 ::</span> <span class="dt">Answer</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true"></a>    ,<span class="ot"> answers2 ::</span> <span class="dt">Maybe</span> <span class="dt">Answer</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true"></a>    ,<span class="ot"> answers3 ::</span> <span class="dt">Maybe</span> <span class="dt">Answer</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true"></a>    }</span></code></pre></div>
<p>Sure, this data type allows many illegal states, and there is a room for improvement. But to be exactly precise in our data description, we probably need to create another enumeration type specifying only valid combinations of <code>Answer</code>s. However, such enumeration will be huge and unmaintainable. Even if your original <code>Answer</code> type has 8 values, the resulting combinations type will have approximately one hundred constructions that you will need to tackle all everytime the original data type changes. In this case, it is not feasible to describe only valid states with a data type, so we don‚Äôt bother doing this.</p>
<section id="make-illegal-states-unrepresentable-task-1" class="exercise">
<h3>Make illegal states unrepresentable: Task 1<a href="#make-illegal-states-unrepresentable-task-1" class="anchor">üîó</a></h3>
<p>Implement the following function by applying the <em>make illegal states unrepresentable</em> pattern.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a><span class="co">-- group sublists of equal elements</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; group &quot;Mississippi&quot;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true"></a><span class="co">-- [&quot;M&quot;,&quot;i&quot;,&quot;ss&quot;,&quot;i&quot;,&quot;ss&quot;,&quot;i&quot;,&quot;pp&quot;,&quot;i&quot;]</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true"></a><span class="fu">group</span><span class="ot"> ::</span> <span class="dt">Eq</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> [[a]]</span></code></pre></div>
<blockquote>
<p><strong>Hint:</strong> Use the <code>NonEmpty</code> list.</p>
</blockquote>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionIllegal1" aria-expanded="false" aria-controls="solutionIllegal1">
Show solution
</button>
<div id="solutionIllegal1" class="solution collapse">
<h4 id="make-illegal-states-unrepresentable-solution-1">Make illegal states unrepresentable: Solution 1<a href="#make-illegal-states-unrepresentable-solution-1" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb37"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.List.NonEmpty</span> (<span class="dt">NonEmpty</span> (..))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true"></a><span class="fu">group</span><span class="ot"> ::</span> <span class="kw">forall</span> a <span class="op">.</span> <span class="dt">Eq</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> [<span class="dt">NonEmpty</span> a]</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true"></a><span class="fu">group</span> <span class="ot">=</span> go</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true"></a><span class="ot">    go ::</span> [a] <span class="ot">-&gt;</span> [<span class="dt">NonEmpty</span> a]</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true"></a>    go [] <span class="ot">=</span> []</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true"></a>    go (x <span class="op">:</span> xs) <span class="ot">=</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true"></a>        <span class="kw">let</span> (ys, zs) <span class="ot">=</span> <span class="fu">span</span> (<span class="op">==</span> x) xs</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true"></a>        <span class="kw">in</span> (x <span class="op">:|</span> ys) <span class="op">:</span> go zs</span></code></pre></div>
</div>
</section>
<section id="make-illegal-states-unrepresentable-task-2" class="exercise">
<h3>Make illegal states unrepresentable: Task 2<a href="#make-illegal-states-unrepresentable-task-2" class="anchor">üîó</a></h3>
<p>Improve the following code by applying the <em>make illegal states unrepresentable</em> pattern.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a><span class="co">-- Find sum of up to the first 3 elements</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a><span class="ot">sumUpToThree ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true"></a>sumUpToThree []        <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Empty list&quot;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true"></a>sumUpToThree [x]       <span class="ot">=</span> x</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true"></a>sumUpToThree [x, y]    <span class="ot">=</span> x <span class="op">+</span> y</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true"></a>sumUpToThree [x, y, z] <span class="ot">=</span> x <span class="op">+</span> y <span class="op">+</span> z</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true"></a>sumUpToThree _         <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;More than three values&quot;</span></span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionIllegal2" aria-expanded="false" aria-controls="solutionIllegal2">
Show solution
</button>
<div id="solutionIllegal2" class="solution collapse">
<h4 id="make-illegal-states-unrepresentable-solution-2">Make illegal states unrepresentable: Solution 2<a href="#make-illegal-states-unrepresentable-solution-2" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb39"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE LambdaCase #-}</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">UpToThree</span> a</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true"></a>    <span class="ot">=</span> <span class="dt">One</span> a</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Two</span> a a</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Three</span> a a a</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true"></a><span class="ot">sumUpToThree ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> <span class="dt">UpToThree</span> a <span class="ot">-&gt;</span> a</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true"></a>sumUpToThree <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true"></a>    <span class="dt">One</span>   a     <span class="ot">-&gt;</span> a</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true"></a>    <span class="dt">Two</span>   a b   <span class="ot">-&gt;</span> a <span class="op">+</span> b</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true"></a>    <span class="dt">Three</span> a b c <span class="ot">-&gt;</span> a <span class="op">+</span> b <span class="op">+</span> c</span></code></pre></div>
</div>
</section>
<h2 id="phantom-type-parameters">Phantom type parameters<a href="#phantom-type-parameters" class="anchor">üîó</a></h2>
<div class="pattern row">
<div class="pattern-header bg-primary col-3">
Pattern
</div>
<div class="pattern-body col-9">
<p>Phantom type parameters</p>
</div>
<div class="pattern-header bg-primary col-3">
Description
</div>
<div class="pattern-body col-9">
<p>Additional type-level information available during compile-time by introducing extra type variables.</p>
</div>
<div class="pattern-header bg-primary col-3">
When to use
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>To avoid duplication of many similar data types.</li>
<li>To increase code type-safety.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Benefits
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>More compile-time guarantees.</li>
<li>Better ergonomics compared to code duplication.</li>
<li>Flexibility.</li>
<li>Extensibility.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Costs
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Need to know when not to use it. Can get out of control when applied to unsuitable situations.</li>
<li>Less beginner-friendly.</li>
</ol>
</div>
</div>
<p>Sometimes you can improve benefits gained with the usage of <code>newtype</code>s even further by using ‚Äúphantom type variables‚Äù ‚Äî type variables that are not used after the ‚Äú=‚Äù sign in the data type declaration. You can exploit them to distinguish usages of the same <code>newtype</code> for different purposes. Instead of writing:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Id</span> <span class="ot">=</span> <span class="dt">Id</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true"></a>    {<span class="ot"> unId ::</span> <span class="dt">Int</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true"></a>    }</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true"></a><span class="ot">isCommentByUser ::</span> <span class="dt">Id</span> <span class="ot">-&gt;</span> <span class="dt">Id</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span></code></pre></div>
<p>or more verbose</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">UserId</span>    <span class="ot">=</span> <span class="dt">UserId</span>    <span class="dt">Int</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">CommentId</span> <span class="ot">=</span> <span class="dt">CommentId</span> <span class="dt">Int</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true"></a><span class="ot">isCommentByUser ::</span> <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">CommentId</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span></code></pre></div>
<p>you can have one newtype to represent that all:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Id</span> a <span class="ot">=</span> <span class="dt">Id</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true"></a>    {<span class="ot"> unId ::</span> <span class="dt">Int</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true"></a>    }</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true"></a><span class="ot">isCommentByUser ::</span> <span class="dt">Id</span> <span class="dt">User</span> <span class="ot">-&gt;</span> <span class="dt">Id</span> <span class="dt">Comment</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span></code></pre></div>
<p>This approach allows you to avoid creating multiple data types that have the same purpose and behaviour.</p>
<p>For example, you can have a lot of instances for your <code>newtype</code>s and don‚Äôt want to repeat them for <code>UserId</code>, <code>AdminId</code>, <code>CommentId</code>, <code>MessageId</code>, etc. but still desire to have more type-safety. Adding a phantom type parameter to a single data type is a minor yet powerful change to your data types that imposes an extra layer of type-safety to your code.</p>
<p>Going back again to our favourite example with passwords: you can have multiple entities that can log into your application (users, administrators, third-parties, etc.). And those different entities may have diverse authentication methods or password validation algorithms. You could use phantom type variables here as well in order to track sign-in information on the type-level and bind the password with its hash using the type-level tag:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Password</span> a <span class="ot">=</span> <span class="dt">Password</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true"></a>    {<span class="ot"> unPassword ::</span> <span class="dt">ByteString</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true"></a>    }</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">PasswordHash</span> a <span class="ot">=</span> <span class="dt">PasswordHash</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true"></a>    {<span class="ot"> unPasswordHash ::</span> <span class="dt">ByteString</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true"></a>    }</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true"></a><span class="co">-- 'PasswordHash' is associated with the same entity as 'Password'</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true"></a><span class="ot">mkPasswordHash ::</span> <span class="dt">Password</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">PasswordHash</span> a)</span></code></pre></div>
<p>Now it is no longer possible to validate the password of a user with the hash of an admin.</p>
<div class="exercise">
<p>üìö <strong>Exercise:</strong> The <code>mkPasswordhash</code> function takes a password and maybe returns password hash. Can you notice which one of the previously discussed patterns is used here? üòâ</p>
</div>
<section id="phantom-type-parameters-task" class="exercise">
<h3>Phantom type parameters: Task<a href="#phantom-type-parameters-task" class="anchor">üîó</a></h3>
<p>Improve the following code by applying the <em>Phantom type parameters</em> pattern. Don‚Äôt worry about function implementations, they are not important in this task.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Binary</span> (<span class="dt">Binary</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.ByteString</span> (<span class="dt">ByteString</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">PrivateKey</span> <span class="ot">=</span> <span class="dt">PrivateKey</span> <span class="dt">ByteString</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">PublicKey</span>  <span class="ot">=</span> <span class="dt">PublicKey</span>  <span class="dt">ByteString</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Signature</span>  <span class="ot">=</span> <span class="dt">Signature</span>  <span class="dt">ByteString</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true"></a><span class="co">-- | Derive public key from secret key.</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true"></a><span class="ot">createPublicKey ::</span> <span class="dt">PrivateKey</span> <span class="ot">-&gt;</span> <span class="dt">PublicKey</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true"></a>createPublicKey <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Not implemented&quot;</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true"></a><span class="co">-- | Sign the data using the given 'PrivateKey'.</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true"></a><span class="ot">sign ::</span> <span class="dt">Binary</span> a <span class="ot">=&gt;</span> <span class="dt">PrivateKey</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Signature</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true"></a>sign <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Not implemented&quot;</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true"></a><span class="co">-- | Check that the signature is produced by the 'PublicKey', derived for the</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true"></a><span class="co">-- corresponding 'PrivateKey' that signed the same type of data</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true"></a><span class="ot">verifySignature ::</span> <span class="dt">Binary</span> a <span class="ot">=&gt;</span> <span class="dt">PublicKey</span> <span class="ot">-&gt;</span> <span class="dt">Signature</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true"></a>verifySignature <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Not implemented&quot;</span></span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionPhantom1" aria-expanded="false" aria-controls="solutionPhantom1">
Show solution
</button>
<div id="solutionPhantom1" class="solution collapse">
<h4 id="phantom-type-parameters-solution">Phantom type parameters: Solution<a href="#phantom-type-parameters-solution" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb45"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Binary</span> (<span class="dt">Binary</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.ByteString</span> (<span class="dt">ByteString</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">PrivateKey</span>  <span class="ot">=</span> <span class="dt">PrivateKey</span> <span class="dt">ByteString</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">PublicKey</span>   <span class="ot">=</span> <span class="dt">PublicKey</span>  <span class="dt">ByteString</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">Signature</span> a <span class="ot">=</span> <span class="dt">Signature</span>  <span class="dt">ByteString</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true"></a><span class="co">-- | Derive public key from secret key.</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true"></a><span class="ot">createPublicKey ::</span> <span class="dt">PrivateKey</span> <span class="ot">-&gt;</span> <span class="dt">PublicKey</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true"></a>createPublicKey <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Not implemented&quot;</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true"></a><span class="co">-- | Sign the data using the given 'PrivateKey'.</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true"></a><span class="ot">sign ::</span> <span class="dt">Binary</span> a <span class="ot">=&gt;</span> <span class="dt">PrivateKey</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Signature</span> a</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true"></a>sign <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Not implemented&quot;</span></span></code></pre></div>
<p>Check that the signature for the following <code>verifySignature</code> function is produced by the <code>PublicKey</code>, derived for the corresponding <code>PrivateKey</code> that signed the same type of data. The implementation guarantees that you cannot verify signature for a different type than the signature was created initially.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true"></a><span class="ot">verifySignature ::</span> <span class="dt">Binary</span> a <span class="ot">=&gt;</span> <span class="dt">PublicKey</span> <span class="ot">-&gt;</span> <span class="dt">Signature</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true"></a>verifySignature <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Not implemented&quot;</span></span></code></pre></div>
</div>
</section>
<h2 id="monadfail-sugar">MonadFail sugar<a href="#monadfail-sugar" class="anchor">üîó</a></h2>
<div class="pattern row">
<div class="pattern-header bg-primary col-3">
Pattern
</div>
<div class="pattern-body col-9">
<p>MonadFail sugar</p>
</div>
<div class="pattern-header bg-primary col-3">
Description
</div>
<div class="pattern-body col-9">
<p>Elegant syntax for pattern-matching on nested or multiple different parts of the data.</p>
</div>
<div class="pattern-header bg-primary col-3">
When to use
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>When doing pattern-matching a lot and when a particular failure reason is not important.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Benefits
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Clean syntax, less noise.</li>
<li>No runtime errors by avoiding partial functions.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Costs
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>No detailed error messages about failures.</li>
<li>No immediate understanding of what code would do in case of the error to pattern-match.</li>
</ol>
</div>
</div>
<p>When time comes to extract deeply-nested fields of a nested data structure, or to perform multiple validations in a single block, you start thinking on the neat way to do it at the best cost. You obviously fancy to avoid using partial functions because they can sometimes hide unhandled cases and fail at runtime unexpectedly.</p>
<p>There is a nice trick that combines the <code>Maybe</code> data type, <code>do</code>-notation and <code>MonadFail</code> typeclass that allows writing such code. Each piece of this spicy combination will be explained further, but first we need to understand the use-case. Let‚Äôs explore the following example.</p>
<p>When you write a function like this:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true"></a><span class="ot">isThisTheAnswer ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true"></a>isThisTheAnswer <span class="dv">42</span> <span class="ot">=</span> <span class="dt">True</span></span></code></pre></div>
<p>and if you pass a number like <code>37</code> to this function, it will surely fail.</p>
<p>However, when you pattern-match on any value on the left side of <code>&lt;-</code> inside <code>do</code>-block, a slightly different set of rules is used for handling non-covered patterns. These rules involve usage of the <code>MonadFail</code> typeclass.</p>
<p>The <code>MonadFail</code> definition has nothing exclusive:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true"></a><span class="kw">class</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">MonadFail</span> m <span class="kw">where</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true"></a><span class="ot">    fail ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> m a</span></code></pre></div>
<p>You can use this typeclass directly by calling the <code>fail</code> method. But most of the time you are using this typeclass implicitly, usually with the <code>IO</code>. It is important to mention here that the <code>fail</code> method of the <code>MonadFail</code> typeclass participates in the desugarisation of <code>do</code> blocks.</p>
<p>In other words, the following sweet code</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true"></a>    [_, arg2] <span class="ot">&lt;-</span> getArgs</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true"></a>    <span class="fu">print</span> arg2</span></code></pre></div>
<p>will be desugared into something like this:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true"></a>main <span class="ot">=</span> getArgs <span class="op">&gt;&gt;=</span> \args <span class="ot">-&gt;</span> <span class="kw">case</span> args <span class="kw">of</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true"></a>    [_, arg2] <span class="ot">-&gt;</span> <span class="fu">print</span> arg2</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true"></a>    _ <span class="ot">-&gt;</span> <span class="fu">fail</span> <span class="st">&quot;Some compiler-generated message&quot;</span></span></code></pre></div>
<p>The <code>MonadFail</code> instance for <code>IO</code> throws an IO exception, but the instance for <code>Maybe</code> is rather curious:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">MonadFail</span> <span class="dt">Maybe</span> <span class="kw">where</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true"></a>    <span class="fu">fail</span> _ <span class="ot">=</span> <span class="dt">Nothing</span>  <span class="co">-- ignore the string input and always return Nothing</span></span></code></pre></div>
<p>Now let‚Äôs have a closer look at a more specific example to understand better how <code>Maybe</code> and <code>MonadFail</code> play together. Let‚Äôs say, we want to perform the following check on our data:</p>
<ul>
<li>extract the last line of the text from some buffer (therefore it should contain at least one line)</li>
<li>make sure that it contains exactly 3 words</li>
<li>the first word must be <code>"CMD"</code></li>
<li>the second word is the number 42</li>
</ul>
<p>In case all the above is true, we want to return the last word in this sequence of words. Such verification can be easily written using the <code>Maybe</code> type and its <code>MonadFail</code> instance:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true"></a><span class="ot">bufferLastLine ::</span> <span class="dt">Buffer</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true"></a><span class="ot">cmdSequence ::</span> <span class="dt">Buffer</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true"></a>cmdSequence buffer <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true"></a>    line <span class="ot">&lt;-</span> bufferLastLine buffer</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true"></a>    [<span class="st">&quot;CMD&quot;</span>, number, cmd] <span class="ot">&lt;-</span> <span class="dt">Just</span> <span class="op">$</span> <span class="fu">words</span> line</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true"></a>    <span class="dv">42</span> <span class="ot">&lt;-</span> readMaybe number</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true"></a>    <span class="fu">pure</span> cmd</span></code></pre></div>
<p>You can see that the code is clean, it does exactly what we expect with a minimal syntactic overhead, and it is also safe as a bonus.</p>
<div class="exercise">
<p>üìö <strong>Exercise:</strong> Desugar the above code manually.</p>
</div>
<hr>
<p>In some cases, when performing multiple checks, it is crucial to know which one failed first in order to run the corresponding action next or provide a better error message for users. In that case, you should use <code>Either</code> instead of <code>Maybe</code>. Or if all your verification checks are independent of each other, you can use the <code>Validation</code> data type to output <strong>all</strong> errors that were fired along the way. This is useful to show the informative error messages to users. The approach with <code>Either</code> will stop on the first error, when the <code>Validation</code> approach will perform all checks anyways.</p>
<p>However, when using more detailed error-reporting, you won‚Äôt be able to make use of this <code>MonadFail</code> trick, because both <code>Either</code> and <code>Validation</code> don‚Äôt implement the <code>MonadFail</code> instance, so the manual pattern-matching or other type of handling is required.</p>
<hr>
<p>Interestingly, unlike <code>Either</code>-like data types, the <code>MonadFail</code> instance for lists in Haskell has a similar power to <code>Maybe</code>‚Äôs. If you have a container of a complicated data structure and your goal is to filter it only by some structure-specific criteria, keeping only interesting elements, you can use <a href="https://wiki.haskell.org/List_comprehension">list comprehension</a> and <code>MonadFail</code> for list. List comprehension is a cute syntax sugar for constructing lists. <code>do</code>-notation is a syntax sugar for <code>&gt;&gt;=</code> from <code>Monad</code>, so you can think about list comprehension as a syntax sugar for <code>do</code>-notation specifically for lists.</p>
<blockquote>
<p>üë©‚Äçüî¨ Haskell also has the <a href="https://downloads.haskell.org/ghc/latest/docs/html/users_guide/glasgow_exts.html#monad-comprehensions">MonadComprehensions</a> extension that allows using the list comprehension syntax for other monads.</p>
</blockquote>
<p>Let‚Äôs say, we get a list of pairs with some <code>Either</code> values as both elements of those pairs, and we want to extract only <code>Int</code>s that are inside both <code>Right</code> and are the same. The description is wordy, but the code for this task with the usage of list comprehension is much more elegant:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true"></a><span class="ot">keepOnlySameRights ::</span> [(<span class="dt">Either</span> e1 <span class="dt">Int</span>, <span class="dt">Either</span> e2 <span class="dt">Int</span>)] <span class="ot">-&gt;</span> [<span class="dt">Int</span>]</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true"></a>keepOnlySameRights xs <span class="ot">=</span> [n <span class="op">|</span> (<span class="dt">Right</span> n, <span class="dt">Right</span> m) <span class="ot">&lt;-</span> xs, n <span class="op">==</span> m]</span></code></pre></div>
<p>If you attempt to implement such a function by using manual pattern-matching, it would look a bit less cleaner.</p>
<div class="exercise">
<p>üìö <strong>Exercise:</strong> Try implementing the <code>keepOnlySameRights</code> functions without list comprehensions and the <code>MonadFail</code> instance for list.</p>
</div>
<section id="monadfail-sugar-task-1" class="exercise">
<h3>MonadFail sugar: Task 1<a href="#monadfail-sugar-task-1" class="anchor">üîó</a></h3>
<p>Implement the following functions applying the <em>MonadFail sugar</em> pattern.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true"></a><span class="co">-- returns sum of exactly 3 numbers separated by spaces in a string</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; sumThree &quot;10 20 15&quot;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true"></a><span class="co">-- Just 45</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; sumThree &quot;10 7&quot;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true"></a><span class="co">-- Nothing</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true"></a><span class="ot">sumThree ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionMonadFail1" aria-expanded="false" aria-controls="solutionMonadFail1">
Show solution
</button>
<div id="solutionMonadFail1" class="solution collapse">
<h4 id="monadfail-sugar-solution-1">MonadFail sugar: Solution 1<a href="#monadfail-sugar-solution-1" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb55"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Text.Read</span> (readMaybe)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true"></a><span class="ot">sumThree ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true"></a>sumThree s <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true"></a>    [a, b, c] <span class="ot">&lt;-</span> <span class="fu">traverse</span> readMaybe <span class="op">$</span> <span class="fu">words</span> s</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true"></a>    <span class="fu">pure</span> <span class="op">$</span> a <span class="op">+</span> b <span class="op">+</span> c</span></code></pre></div>
</div>
</section>
<section id="monadfail-sugar-task-2" class="exercise">
<h3>MonadFail sugar: Task 2<a href="#monadfail-sugar-task-2" class="anchor">üîó</a></h3>
<p>Implement the following functions applying the <em>MonadFail sugar</em> pattern.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true"></a><span class="co">-- return only values inside Just</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true"></a><span class="ot">catMaybes ::</span> [<span class="dt">Maybe</span> a] <span class="ot">-&gt;</span> [a]</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionMonadFail2" aria-expanded="false" aria-controls="solutionMonadFail2">
Show solution
</button>
<div id="solutionMonadFail2" class="solution collapse">
<h4 id="monadfail-sugar-solution-2">MonadFail sugar: Solution 2<a href="#monadfail-sugar-solution-2" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb57"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true"></a><span class="ot">catMaybes ::</span> [<span class="dt">Maybe</span> a] <span class="ot">-&gt;</span> [a]</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true"></a>catMaybes xs <span class="ot">=</span> [x <span class="op">|</span> <span class="dt">Just</span> x <span class="ot">&lt;-</span> xs]</span></code></pre></div>
</div>
</section>
<section id="monadfail-sugar-task-3" class="exercise">
<h3>MonadFail sugar: Task 3<a href="#monadfail-sugar-task-3" class="anchor">üîó</a></h3>
<p>Implement the following functions applying the <em>MonadFail sugar</em> pattern.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true"></a><span class="co">-- return 'b's only from 'Just'</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true"></a><span class="ot">mapMaybe ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [b]</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionMonadFail3" aria-expanded="false" aria-controls="solutionMonadFail3">
Show solution
</button>
<div id="solutionMonadFail3" class="solution collapse">
<h4 id="monadfail-sugar-solution-3">MonadFail sugar: Solution 3<a href="#monadfail-sugar-solution-3" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb59"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true"></a><span class="ot">mapMaybe ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [b]</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true"></a>mapMaybe f as <span class="ot">=</span> [b <span class="op">|</span> a <span class="ot">&lt;-</span> as, <span class="dt">Just</span> b <span class="ot">&lt;-</span> [f a]]</span></code></pre></div>
</div>
</section>
<section id="monadfail-sugar-task-4" class="exercise">
<h3>MonadFail sugar: Task 4<a href="#monadfail-sugar-task-4" class="anchor">üîó</a></h3>
<p>Implement the following functions applying the <em>MonadFail sugar</em> pattern.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true"></a><span class="co">-- return @Just ()@ only if all three arguments are Nothing</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true"></a><span class="ot">threeNothing ::</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b <span class="ot">-&gt;</span> <span class="dt">Maybe</span> c <span class="ot">-&gt;</span> <span class="dt">Maybe</span> ()</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionMonadFail4" aria-expanded="false" aria-controls="solutionMonadFail4">
Show solution
</button>
<div id="solutionMonadFail4" class="solution collapse">
<h4 id="monadfail-sugar-solution-4">MonadFail sugar: Solution 4<a href="#monadfail-sugar-solution-4" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb61"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true"></a><span class="ot">threeNothing ::</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b <span class="ot">-&gt;</span> <span class="dt">Maybe</span> c <span class="ot">-&gt;</span> <span class="dt">Maybe</span> ()</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true"></a>threeNothing ma mb mc <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">&lt;-</span> <span class="dt">Just</span> ma</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">&lt;-</span> <span class="dt">Just</span> mb</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">&lt;-</span> <span class="dt">Just</span> mc</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true"></a>    <span class="fu">pure</span> ()</span></code></pre></div>
</div>
</section>
<h2 id="polymorphisation">Polymorphisation<a href="#polymorphisation" class="anchor">üîó</a></h2>
<div class="pattern row">
<div class="pattern-header bg-primary col-3">
Pattern
</div>
<div class="pattern-body col-9">
<p>Polymorphisation</p>
</div>
<div class="pattern-header bg-primary col-3">
Description
</div>
<div class="pattern-body col-9">
<p>Assigning a more general type to a function reduces the chances of writing an incorrect implementation or providing incorrect inputs.</p>
</div>
<div class="pattern-header bg-primary col-3">
When to use
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>To reduce risks of using function incorrectly.</li>
<li>To use the same function on values of different types.</li>
<li>To make illegal states unrepresentable.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Benefits
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Need to write fewer tests (or no tests at all!).</li>
<li>Increases code reusability.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Costs
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Can make type signatures look more complicated.</li>
<li>Reusing polymorphic types in <code>where</code> requires enabling the <code>ScopedTypeVariables</code> extension, and this might be confusing for beginners.</li>
</ol>
</div>
</div>
<p>Haskell has the <a href="https://wiki.haskell.org/Polymorphism">Polymorphism</a> feature and allows writing and using polymorphic data types and functions. A polymorphic function can be defined only once for some general types, and then it can be called with arguments of different types, satisfying the type signature.</p>
<p>For example, the following function</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true"></a><span class="ot">firstArg ::</span> a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> a</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true"></a>firstArg x _ <span class="ot">=</span> x</span></code></pre></div>
<p>can have types, depending on arguments, either <code>firstArgs :: Int -&gt; String -&gt; Int</code> or <code>firstArg :: Maybe s -&gt; [a] -&gt; Maybe s</code> but not <code>firstArg :: Int -&gt; Double -&gt; Double</code>.</p>
<p>If a monomorphic function has type <code>Int -&gt; Int</code> then it can do many different things and you can‚Äôt really guess its behaviour by only looking at its type. You can guess by the function name, but naming is hard and you still need to check the documentation and probably even source code.</p>
<p>However, if the function‚Äôs type is general as <code>a -&gt; a</code> then this function can do only one thing and in that case, its name doesn‚Äôt matter, you already know what it does.</p>
<div class="exercise">
<p>üìö <strong>Exercise:</strong> Do you see what the function with the type <code>a -&gt; a</code> does?</p>
</div>
<p>The thought that a more general function is less powerful is counter-intuitive. If it can work with more types, how can it be less powerful?</p>
<p>But the more you think about this, the more sense it starts making. The more polymorphic the type is, the less information we know about arguments, the more common types satisfying constraints should be, and the fewer things you can do with them. You can‚Äôt create values of some unknown type <code>a</code> out of nowhere because you don‚Äôt know their constructor methods. On the other hand, you can do a lot of things with some specific type like <code>Int</code>: increment, decrement, divide, square, return always 0, return last digit, etc.</p>
<p>This fact can be used to implement safer interfaces. The following elaborate example demonstrates key features of the polymorphisation approach.</p>
<p>Let‚Äôs say we want to implement a function that compares two pairs of <code>Int</code>s and something else by the first element of a pair:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true"></a>compareByFst</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true"></a><span class="ot">    ::</span> (<span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Ordering</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true"></a>    <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Bool</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true"></a>    <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Bool</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Ordering</span></span></code></pre></div>
<p>This type is fine, however, it‚Äôs possible to implement not exactly what we wanted but still satisfy this type signature. For example:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true"></a>compareByFst cmp (a, _) (b, _) <span class="ot">=</span> cmp (a <span class="op">+</span> <span class="dv">1</span>) (b <span class="op">+</span> <span class="dv">1</span>)</span></code></pre></div>
<div class="exercise">
<p>üìö <strong>Exercise:</strong> Can you see when this function can produce wrong results?</p>
</div>
<p>We want to restrict what the function can do. So instead of using <code>Int</code> we can use some polymorphic variable:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true"></a><span class="ot">compareByFst ::</span> (a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Ordering</span>) <span class="ot">-&gt;</span> (a, x) <span class="ot">-&gt;</span> (a, x) <span class="ot">-&gt;</span> <span class="dt">Ordering</span></span></code></pre></div>
<p>Though, since the function produces <code>Ordering</code>, you still can simply ignore all arguments and return <code>EQ</code> in all cases. But we can notice, that there‚Äôs no need to stick to the <code>Ordering</code> as well:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true"></a><span class="ot">compareByFst ::</span> (a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> c) <span class="ot">-&gt;</span> (a, x) <span class="ot">-&gt;</span> (a, x) <span class="ot">-&gt;</span> c</span></code></pre></div>
<p>However, this function still has a problem: it is possible to apply arguments in the wrong order. The following two implementations are valid:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true"></a>compareByFst cmp (a, _) (b, _) <span class="ot">=</span> cmp a b</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true"></a>compareByFst cmp (a, _) (b, _) <span class="ot">=</span> cmp b a</span></code></pre></div>
<p>When you are working only on this function, you may notice such logic errors during the development. However, programmers are humans. They can be sleepy or they can do some typos which can totally happen when you change a lot of code. And moreover, it is quite troublesome to debug them.</p>
<p>So let‚Äôs do the final step and specify the most general form of this function, renaming it as well since it has nothing to do with <code>compare</code> anymore:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true"></a><span class="ot">applyToFst ::</span> (a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> c) <span class="ot">-&gt;</span> (a, x) <span class="ot">-&gt;</span> (b, y) <span class="ot">-&gt;</span> c</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true"></a>applyToFst f (a, _) (b, _) <span class="ot">=</span> f a b</span></code></pre></div>
<p>Now, there is only one way to implement <code>applyToFst</code>! If you write a wrong implementation, the compiler will tell you, and such bugs won‚Äôt be even introduced in the first place before it goes to production. Furthermore, since the function is polymorphic, you don‚Äôt need to change the code that uses this function. We can easily restore our first type signature from a polymorphic one by equating specific types with monomorphic variables:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true"></a>a <span class="op">~</span> <span class="dt">Int</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true"></a>b <span class="op">~</span> <span class="dt">Int</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true"></a>c <span class="op">~</span> <span class="dt">Ordering</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true"></a>x <span class="op">~</span> <span class="dt">Bool</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true"></a>y <span class="op">~</span> <span class="dt">Bool</span></span></code></pre></div>
<p>Moreover, the described approach can be applied to already polymorphic functions, which are not polymorphic enough. Consider the following example of a general-purpose function that can be improved by the Polymorphisation technique:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true"></a><span class="ot">partition ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> ([a], [a])</span></code></pre></div>
<p>The intention of this function is to separate elements of the list into two lists by predicate. Unfortunately, this type signature has several problems:</p>
<ol type="1">
<li>It‚Äôs not clear, in which part of the tuple go elements that satisfy the predicate.</li>
<li>In the implementation of this function you still can add elements to a wrong list.</li>
</ol>
<p>A better type signature would be:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true"></a><span class="ot">partitionWith ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Either</span> b c) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> ([b], [c])</span></code></pre></div>
<p>Now it is much harder to implement this function in the wrong way and its type signature also tells us much more about its behaviour!</p>
<div class="exercise">
<p>üìö <strong>Exercise:</strong> Implement <code>partitionWith</code>.</p>
</div>
<blockquote>
<p>üë©‚Äçüî¨ It is still possible to implement <code>partition</code> in a wrong way by not adding elements to the result list. However, LinearTypes can help with ensuring this invariant.</p>
</blockquote>
<p>This trick is especially good with the <a href="#monadfail-sugar">MonadFail sugar</a> pattern. Instead of filtering elements by predicate and using unsafe conversion functions, you can use <code>mapMaybe</code> and make illegal states unrepresentable.</p>
<p>Look at the following function:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; sumEven &quot;100 15 20 7&quot;</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true"></a><span class="co">-- 60</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true"></a><span class="ot">sumEven ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true"></a>sumEven <span class="ot">=</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true"></a>    <span class="fu">sum</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true"></a>    <span class="op">.</span> <span class="fu">map</span> (<span class="ot">`div`</span> <span class="dv">2</span>)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true"></a>    <span class="op">.</span> <span class="fu">filter</span> <span class="fu">even</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true"></a>    <span class="op">.</span> <span class="fu">map</span> <span class="fu">read</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true"></a>    <span class="op">.</span> <span class="fu">filter</span> isNumber</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true"></a>    <span class="op">.</span> <span class="fu">words</span></span></code></pre></div>
<p>It can be written in a slightly different way, that also allows extending filtering rules easily:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true"></a><span class="ot">sumEven ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true"></a>sumEven <span class="ot">=</span> <span class="fu">sum</span> <span class="op">.</span> mapMaybe parseNumber <span class="op">.</span> <span class="fu">words</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true"></a><span class="ot">    parseNumber ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true"></a>    parseNumber str <span class="ot">=</span> <span class="kw">do</span>  <span class="co">-- do-notation for Maybe monad</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true"></a>        num <span class="ot">&lt;-</span> readMaybe str</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true"></a>        guard <span class="op">$</span> <span class="fu">even</span> num</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true"></a>        <span class="fu">pure</span> <span class="op">$</span> num <span class="ot">`div`</span> <span class="dv">2</span></span></code></pre></div>
<section id="polymorphisation-task-1" class="exercise">
<h3>Polymorphisation: Task 1<a href="#polymorphisation-task-1" class="anchor">üîó</a></h3>
<p>Improve the following functions by applying the <strong>Polymorphisation</strong> pattern.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true"></a><span class="co">-- append all elements inside all Just values</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; maybeConcat [Just [1,2,3], Nothing, Just [4,5]]</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true"></a><span class="co">-- [1,2,3,4,5]</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true"></a><span class="ot">maybeConcat ::</span> [<span class="dt">Maybe</span> [<span class="dt">Int</span>]] <span class="ot">-&gt;</span> [<span class="dt">Int</span>]</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionPolymorphisation1" aria-expanded="false" aria-controls="solutionPolymorphisation1">
Show solution
</button>
<div id="solutionPolymorphisation1" class="solution collapse">
<h4 id="polymorphisation-solution-1">Polymorphisation: Solution 1<a href="#polymorphisation-solution-1" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb75"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Foldable</span> (fold)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (catMaybes)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true"></a><span class="co">-- 'maybeConcat' that works with any lists</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true"></a><span class="ot">maybeConcatList ::</span> [<span class="dt">Maybe</span> [a]] <span class="ot">-&gt;</span> [a]</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true"></a>maybeConcatList <span class="ot">=</span> <span class="fu">concat</span> <span class="op">.</span> catMaybes</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true"></a><span class="co">-- 'maybeConcat' that works with any monoid</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true"></a><span class="ot">maybeMconcat ::</span> <span class="dt">Monoid</span> m <span class="ot">=&gt;</span> [<span class="dt">Maybe</span> m] <span class="ot">-&gt;</span> m</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true"></a>maybeMconcat <span class="ot">=</span> <span class="fu">mconcat</span> <span class="op">.</span> catMaybes</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true"></a></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true"></a><span class="co">-- 'maybeConcat' that works with any foldable container of maybe monoids</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true"></a><span class="ot">foldMaybes ::</span> (<span class="dt">Foldable</span> f, <span class="dt">Monoid</span> m) <span class="ot">=&gt;</span> f (<span class="dt">Maybe</span> m) <span class="ot">-&gt;</span> m</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true"></a>foldMaybes <span class="ot">=</span> fold <span class="op">.</span> fold</span></code></pre></div>
</div>
</section>
<section id="polymorphisation-task-2" class="exercise">
<h3>Polymorphisation: Task 2<a href="#polymorphisation-task-2" class="anchor">üîó</a></h3>
<div class="sourceCode" id="cb76"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true"></a><span class="co">-- return lists containing a given integer</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; containsInt 3 [[1..5], [2,0], [3,4]]</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true"></a><span class="co">-- [[1,2,3,4,5], [3,4]]</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true"></a><span class="ot">containsInt ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> [[<span class="dt">Int</span>]] <span class="ot">-&gt;</span> [[<span class="dt">Int</span>]]</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionPolymorphisation2" aria-expanded="false" aria-controls="solutionPolymorphisation2">
Show solution
</button>
<div id="solutionPolymorphisation2" class="solution collapse">
<h4 id="polymorphisation-solution-2">Polymorphisation: Solution 2<a href="#polymorphisation-solution-2" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb77"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true"></a><span class="co">-- works with any value, not only 'Int'</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true"></a><span class="ot">containsElem ::</span> <span class="dt">Eq</span> e <span class="ot">=&gt;</span> e <span class="ot">-&gt;</span> [[e]] <span class="ot">-&gt;</span> [[e]]</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true"></a>containsElem e <span class="ot">=</span> <span class="fu">filter</span> (<span class="fu">elem</span> e)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true"></a><span class="co">-- works with any value and any Foldable container inside lists</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true"></a><span class="ot">containsElem ::</span> (<span class="dt">Foldable</span> f, <span class="dt">Eq</span> e) <span class="ot">=&gt;</span> e <span class="ot">-&gt;</span> [f e] <span class="ot">-&gt;</span> [f e]</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true"></a>containsElem <span class="ot">=</span> <span class="fu">filter</span> <span class="op">.</span> <span class="fu">elem</span></span></code></pre></div>
</div>
</section>
<section id="polymorphisation-task-3" class="exercise">
<h3>Polymorphisation: Task 3<a href="#polymorphisation-task-3" class="anchor">üîó</a></h3>
<pre><code>-- split list in two parts stopping when predicate returns false
-- &gt;&gt;&gt; span (&lt; 3) [1, 2, 4, 2]
-- ([1, 2], [4, 2])
span :: (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])</code></pre>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionPolymorphisation3" aria-expanded="false" aria-controls="solutionPolymorphisation3">
Show solution
</button>
<div id="solutionPolymorphisation3" class="solution collapse">
<h4 id="polymorphisation-solution-3">Polymorphisation: Solution 3<a href="#polymorphisation-solution-3" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb79"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Bifunctor</span> (first)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true"></a></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true"></a><span class="co">-- one possible way of making 'span' more polymorphic</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; splitWhile (\x -&gt; if x &lt; 3 then Just x else Nothing) [1, 2, 4, 2]</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true"></a><span class="co">-- ([1, 2], [4, 2])</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true"></a><span class="ot">splitWhile ::</span> <span class="kw">forall</span> b a <span class="op">.</span> (a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> ([b], [a])</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true"></a>splitWhile f <span class="ot">=</span> go</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true"></a><span class="ot">    go ::</span> [a] <span class="ot">-&gt;</span> ([b], [a])</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true"></a>    go [] <span class="ot">=</span> ([], [])</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true"></a>    go (a<span class="op">:</span>as) <span class="ot">=</span> <span class="kw">case</span> f a <span class="kw">of</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> ([], a <span class="op">:</span> as)</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true"></a>        <span class="dt">Just</span> b <span class="ot">-&gt;</span> first (b<span class="op">:</span>) (go as)</span></code></pre></div>
</div>
</section>
<h2 id="bidirectional-parsing">Bidirectional parsing<a href="#bidirectional-parsing" class="anchor">üîó</a></h2>
<div class="pattern row">
<div class="pattern-header bg-primary col-3">
Pattern
</div>
<div class="pattern-body col-9">
<p>Bidirectional parsing</p>
</div>
<div class="pattern-header bg-primary col-3">
Description
</div>
<div class="pattern-body col-9">
<p>Matching only a limited set with exhaustiveness checking and inversing matching function automatically.</p>
</div>
<div class="pattern-header bg-primary col-3">
When to use
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>When you need to show enumerations and parse them back.</li>
<li>When the <code>show</code> function is injective (maps distinct constructors to distinct values).</li>
<li>Basically, for any bidirectional conversion by implementing only one direction and getting the inverse conversion for free.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Benefits
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Automatic code correctness by implementation.</li>
<li>Easier maintainability.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Costs
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Extra dependencies or extra code.</li>
<li>Less manual control over code.</li>
</ol>
</div>
</div>
<p>It is often in programs, that you use enumeration types (data types with several constructors without any fields). Enums are classy at least because when we pattern-match on them, GHC yells at us about cases we forgot. But things become a bit more complicated when you also want to be able to parse your enums from strings, which is a completely sane and frequent requirement. This is problematic because when handling strings via pattern-matching, you are physically unable to handle all cases because there is an infinite number of them.</p>
<p>Consider the following example:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Colour</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true"></a>    <span class="ot">=</span> <span class="dt">Green</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Yellow</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Blue</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true"></a><span class="ot">showColour ::</span> <span class="dt">Colour</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true"></a>showColour <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true"></a>    <span class="dt">Green</span>  <span class="ot">-&gt;</span> <span class="st">&quot;green&quot;</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true"></a>    <span class="dt">Yellow</span> <span class="ot">-&gt;</span> <span class="st">&quot;yellow&quot;</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true"></a>    <span class="dt">Blue</span>   <span class="ot">-&gt;</span> <span class="st">&quot;blue&quot;</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true"></a><span class="ot">parseColour ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Colour</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true"></a>parseColour <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true"></a>    <span class="st">&quot;green&quot;</span>  <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">Green</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true"></a>    <span class="st">&quot;yellow&quot;</span> <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">Yellow</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true"></a>    <span class="st">&quot;blue&quot;</span>   <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">Blue</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true"></a>    _        <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span></code></pre></div>
<blockquote>
<p>It‚Äôs important that you pattern match on all cases of enumeration when possible to avoid having partial functions.</p>
</blockquote>
<p>If you add a new colour constructor, for example <code>Orange</code>, the compiler will warn you to update the <code>showColour</code> function. But, unfortunately, it won‚Äôt remind you to update <code>parseColour</code> as the <code>"orange"</code> string is already covered by the wildcard (<code>_</code>) case. Therefore it is all good from the compiler point of view.</p>
<p>If you have only a few data types with a few constructors and you don‚Äôt update them, then you don‚Äôt have such a problem. Otherwise it is not straightforward to maintain such code.</p>
<p>Fortunately, there is a way to avoid this issue. You can implement helper functions that will parse your enumeration types from text back to safe Haskell data types. One of such functions is <code>inverseMap</code> from <a href="https://hackage.haskell.org/package/relude">relude</a>:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true"></a>inverseMap</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true"></a><span class="ot">    ::</span> <span class="kw">forall</span> e s <span class="op">.</span> (<span class="dt">Bounded</span> e, <span class="dt">Enum</span> e, <span class="dt">Ord</span> s)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true"></a>    <span class="ot">=&gt;</span> (e <span class="ot">-&gt;</span> s)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true"></a>    <span class="ot">-&gt;</span> s</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Maybe</span> e</span></code></pre></div>
<div class="exercise">
<p>üìö <strong>Exercise:</strong> Implement the <code>inverseMap</code> function.</p>
</div>
<p>Using this function, you can rewrite <code>parseColour</code> in a simpler and more safe way:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true"></a><span class="ot">parseColour ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Colour</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true"></a>parseColour <span class="ot">=</span> inverseMap showColour</span></code></pre></div>
<p>Even if you are not using the <code>showColour</code> function, this approach still can be a better solution, since you can handle cases exhaustively and get a parsing function for free.</p>
<p>You can find <a href="http://hackage.haskell.org/package/relude-0.6.0.0/docs/Relude-Extra-Enum.html#v:inverseMap">more details about this approach in the Haddock documentation</a> for the <code>inverseMap</code> function.</p>
<section id="bidirectional-parsing-task" class="exercise">
<h3>Bidirectional parsing: Task<a href="#bidirectional-parsing-task" class="anchor">üîó</a></h3>
<p>Implement a function that will take a string of two space-separate words ‚Äî colour and fruit name ‚Äî and return them as data types.</p>
<p>Possible colours: red, green, yellow, blue. Possible fruits: apple, orange, lemon, blueberry.</p>
<p>Example:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true"></a>ghci<span class="op">&gt;</span> parseFruit <span class="st">&quot;red apple&quot;</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true"></a><span class="dt">Just</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true"></a>    ( <span class="dt">Fruit</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true"></a>        { fruitColour <span class="ot">=</span> <span class="dt">Red</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true"></a>        , fruitName <span class="ot">=</span> <span class="dt">Apple</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true"></a>        }</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true"></a>    )</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionBiParsing" aria-expanded="false" aria-controls="solutionBiParsing">
Show solution
</button>
<div id="solutionBiParsing" class="solution collapse">
<h4 id="bidirectional-parsing-solution">Bidirectional parsing: Solution<a href="#bidirectional-parsing-solution" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb84"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE DerivingStrategies #-}</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true"></a><span class="ot">{-# LANGUAGE LambdaCase         #-}</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true"></a><span class="ot">{-# LANGUAGE OverloadedStrings  #-}</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true"></a><span class="ot">{-# LANGUAGE RecordWildCards    #-}</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Bi</span> <span class="kw">where</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true"></a></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Relude.Extra.Enum</span> (inverseMap)</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true"></a></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">Text</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true"></a></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true"></a></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Colour</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true"></a>    <span class="ot">=</span> <span class="dt">Red</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Green</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Yellow</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Blue</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true"></a>    <span class="kw">deriving</span> stock (<span class="dt">Show</span>, <span class="dt">Enum</span>, <span class="dt">Bounded</span>)</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true"></a></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true"></a><span class="ot">showColour ::</span> <span class="dt">Colour</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true"></a>showColour <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true"></a>    <span class="dt">Red</span>    <span class="ot">-&gt;</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true"></a>    <span class="dt">Green</span>  <span class="ot">-&gt;</span> <span class="st">&quot;green&quot;</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true"></a>    <span class="dt">Yellow</span> <span class="ot">-&gt;</span> <span class="st">&quot;yellow&quot;</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true"></a>    <span class="dt">Blue</span>   <span class="ot">-&gt;</span> <span class="st">&quot;blue&quot;</span></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true"></a></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true"></a><span class="ot">parseColour ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Colour</span></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true"></a>parseColour <span class="ot">=</span> inverseMap showColour</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true"></a></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">FruitName</span></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true"></a>    <span class="ot">=</span> <span class="dt">Apple</span></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Orange</span></span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Lemon</span></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Blueberry</span></span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true"></a>    <span class="kw">deriving</span> stock (<span class="dt">Show</span>, <span class="dt">Enum</span>, <span class="dt">Bounded</span>)</span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true"></a></span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true"></a><span class="ot">showFruitName ::</span> <span class="dt">FruitName</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true"></a>showFruitName <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true"></a>    <span class="dt">Apple</span>     <span class="ot">-&gt;</span> <span class="st">&quot;apple&quot;</span></span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true"></a>    <span class="dt">Orange</span>    <span class="ot">-&gt;</span> <span class="st">&quot;orange&quot;</span></span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true"></a>    <span class="dt">Lemon</span>     <span class="ot">-&gt;</span> <span class="st">&quot;lemon&quot;</span></span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true"></a>    <span class="dt">Blueberry</span> <span class="ot">-&gt;</span> <span class="st">&quot;blueberry&quot;</span></span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true"></a></span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true"></a><span class="ot">parseFruitName ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">FruitName</span></span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true"></a>parseFruitName <span class="ot">=</span> inverseMap showFruitName</span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true"></a></span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Fruit</span> <span class="ot">=</span> <span class="dt">Fruit</span></span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true"></a>    {<span class="ot"> fruitColour ::</span> <span class="op">!</span><span class="dt">Colour</span></span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true"></a>    ,<span class="ot"> fruitName   ::</span> <span class="op">!</span><span class="dt">FruitName</span></span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true"></a>    } <span class="kw">deriving</span> stock (<span class="dt">Show</span>)</span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true"></a></span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true"></a><span class="ot">parseFruit ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Fruit</span></span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true"></a>parseFruit t <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true"></a>    [colour, name] <span class="ot">&lt;-</span> <span class="dt">Just</span> <span class="op">$</span> Text.words t</span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true"></a>    fruitColour    <span class="ot">&lt;-</span> parseColour colour</span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true"></a>    fruitName      <span class="ot">&lt;-</span> parseFruitName name</span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true"></a>    <span class="fu">pure</span> <span class="dt">Fruit</span>{<span class="op">..</span>}</span></code></pre></div>
</div>
</section>
<h2 id="recursive-go">Recursive go<a href="#recursive-go" class="anchor">üîó</a></h2>
<div class="pattern row">
<div class="pattern-header bg-primary col-3">
Pattern
</div>
<div class="pattern-body col-9">
<p>Recursive <code>go</code></p>
</div>
<div class="pattern-header bg-primary col-3">
Description
</div>
<div class="pattern-body col-9">
<p>Moving recursion over data types into the separate function.</p>
</div>
<div class="pattern-header bg-primary col-3">
When to use
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>When recursion reuses some arguments and you want to avoid passing them again.</li>
<li>When recursion uses some internal state.</li>
<li>To avoid revalidating the same data.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Benefits
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>Cleaner code.</li>
<li>Possible performance improvements.</li>
</ol>
</div>
<div class="pattern-header bg-primary col-3">
Costs
</div>
<div class="pattern-body col-9">
<ol type="1">
<li>More code.</li>
<li>Requires to know about and enable the <code>ScopedTypeVariables</code> extension.</li>
</ol>
</div>
</div>
<blockquote>
<p>üôÖ <strong>Disclaimer</strong> This pattern is not about recursive functions in the Go programming language.</p>
</blockquote>
<p>Quite often Haskell developers end-up writing functions that recursively do some actions on different data types: lists, trees, numeric accumulators, etc. A function that returns the element of the list at the given position (if found) can be considered as the example of such function. And it could be written using pattern matching.</p>
<p>It is important that such a function has a stopping condition, and a step to recursively iterate through the list. In our case the stop signals are:</p>
<ul>
<li>Either you found the element on the given position</li>
<li>Or you traversed the whole list but didn‚Äôt find what you need</li>
</ul>
<p>The step for this function is to examine the tail of the list (throwing away the first element) and decreasing the position number by one (for each thrown element).</p>
<p>Haskell implementation may look like this:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true"></a><span class="ot">at ::</span> [a] <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true"></a>[] <span class="ot">`at`</span> _ <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true"></a>(x<span class="op">:</span>_) <span class="ot">`at`</span> <span class="dv">0</span> <span class="ot">=</span> <span class="dt">Just</span> x</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true"></a>(_<span class="op">:</span>xs) <span class="ot">`at`</span> i <span class="ot">=</span> xs <span class="ot">`at`</span> (i <span class="op">-</span> <span class="dv">1</span>)</span></code></pre></div>
<p>However, there is another way to write the above function. Here we are going to use the recursive <code>go</code> pattern ‚Äì the pattern when instead of using the function itself for the recursion, you create the internal so-called <code>go</code> function that will do that.</p>
<p>The idea here is to run the <code>go</code> function with the empty ‚Äúaccumulator‚Äù and the starting list, and the <code>go</code> function should recursively update the accumulator and walk the whole list. This accumulator would be compared to the input position (in contrast to the comparison to 0 when you decrease the original value in the previous case).</p>
<p>You can code this idea this way:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true"></a><span class="ot">atGo ::</span> [a] <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true"></a>l <span class="ot">`atGo`</span> n <span class="ot">=</span> go <span class="dv">0</span> l</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true"></a><span class="ot">    go ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true"></a>    go _ [] <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true"></a>    go i (x<span class="op">:</span>xs) <span class="ot">=</span> <span class="kw">if</span> i <span class="op">==</span> n <span class="kw">then</span> <span class="dt">Just</span> x <span class="kw">else</span> go (i <span class="op">+</span> <span class="dv">1</span>) xs</span></code></pre></div>
<p>The way the <code>go</code> pattern is implemented also is more flexible in the refactoring and ‚Äúrequirements‚Äù-change. If you, for example, need to check the <code>at</code> function index input on the negative number, it would be much easier and much more efficient to add this validation before the <code>go</code> function of <code>atGo</code>. You don‚Äôt need to check the number of negativity with each recursive call. You can do this only once, and the recursive <code>go</code> function will work only with valid data.</p>
<div class="exercise">
<p>üìö <strong>Exercise:</strong> Can you make these <code>at</code>/<code>atGo</code> functions more efficient on the corner cases?</p>
</div>
<p>This pattern could be especially handy when you need to do additional actions on the input data after you get the result of the recursive calculations. Or if you want to avoid passing arguments that never change during the recursive traverse of your data structure (e.g.¬†<code>map</code>, <code>filter</code>, <code>foldr</code>, etc.).</p>
<section id="recursive-go-task-1" class="exercise">
<h3>Recursive go: Task 1<a href="#recursive-go-task-1" class="anchor">üîó</a></h3>
<p>Improve the following code by applying the <em>Recursive <code>go</code></em> pattern.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true"></a><span class="fu">sum</span><span class="ot"> ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true"></a><span class="fu">sum</span> [] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true"></a><span class="fu">sum</span> (x<span class="op">:</span>xs) <span class="ot">=</span> x <span class="op">+</span> <span class="fu">sum</span> xs</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionRecursiveGo1" aria-expanded="false" aria-controls="solutionRecursiveGo1">
Show solution
</button>
<div id="solutionRecursiveGo1" class="solution collapse">
<h4 id="recursive-go-solution-1">Recursive go: Solution 1<a href="#recursive-go-solution-1" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb88"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE BangPatterns        #-}</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true"></a><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true"></a><span class="ot">sumGo ::</span> <span class="kw">forall</span> a <span class="op">.</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true"></a>sumGo <span class="ot">=</span> go <span class="dv">0</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true"></a><span class="ot">    go ::</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> a</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true"></a>    go <span class="op">!</span>acc [] <span class="ot">=</span> acc</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true"></a>    go acc (x<span class="op">:</span>xs) <span class="ot">=</span> go (acc <span class="op">+</span> x) xs</span></code></pre></div>
</div>
</section>
<section id="recursive-go-task-2" class="exercise">
<h3>Recursive go: Task 2<a href="#recursive-go-task-2" class="anchor">üîó</a></h3>
<p>Write the <code>ordNub</code> function with the <em>Recursive <code>go</code></em> pattern. The function should return all unique elements from a list in the order of their appearance.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true"></a><span class="ot">ordNub ::</span> <span class="dt">Ord</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> [a]</span></code></pre></div>
<div class="sourceCode" id="cb90"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true"></a><span class="op">&gt;&gt;&gt;</span> ordNub [<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true"></a>[<span class="dv">3</span>,<span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>]</span></code></pre></div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#solutionRecursiveGo2" aria-expanded="false" aria-controls="solutionRecursiveGo2">
Show solution
</button>
<div id="solutionRecursiveGo2" class="solution collapse">
<h4 id="recursive-go-solution-2">Recursive go: Solution 2<a href="#recursive-go-solution-2" class="anchor">üîó</a></h4>
<div class="sourceCode" id="cb91"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Set</span> <span class="kw">as</span> <span class="dt">Set</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true"></a><span class="ot">ordNub ::</span> <span class="kw">forall</span> a <span class="op">.</span> (<span class="dt">Ord</span> a) <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> [a]</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true"></a>ordNub <span class="ot">=</span> go Set.empty</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true"></a><span class="ot">    go ::</span> <span class="dt">Set.Set</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a]</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true"></a>    go _ []     <span class="ot">=</span> []</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true"></a>    go s (x<span class="op">:</span>xs) <span class="ot">=</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true"></a>      <span class="kw">if</span> x <span class="ot">`Set.member`</span> s</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true"></a>      <span class="kw">then</span> go s xs</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true"></a>      <span class="kw">else</span> x <span class="op">:</span> go (Set.insert x s) xs</span></code></pre></div>
</div>
</section>
<h2 id="conclusion">Conclusion<a href="#conclusion" class="anchor">üîó</a></h2>
<p>In this blog post we covered some small techniques that increase code maintainability, readability and reusability. You can see how different Haskell features come together. Each pattern is a small improvement, but when used properly, they increase code quality significantly. Try to use them in your next Haskell project and let us know if they help! We hope that the described patterns will help you write better code.</p>
              </p>
              </div>
            </div>

          </div>
      </div>
<footer class="footer text-center">
  <div class="row">
    <div class="col-12 post-body">
      <hr class="star-light">
    </div>
  </div>
  <div class="row justify-content-center align-items-center">
      <div class="col-md-4 mb-5 mb-lg-0">
          <h4 class="text-uppercase mb-4">Support our work</h4>
      </div>
      <div class="col-md-4 mb-5 mb-lg-0">
          <h4 class="text-uppercase mb-4">Subscribe</h4>
      </div>
      <div class="col-md-4 mb-5 mb-lg-0">
          <h4 class="text-uppercase mb-4">Follow us</h4>
      </div>
  </div>
  <div class="row justify-content-center align-items-center">
      <div class="col-md-4 mb-5 mb-lg-0">
          <p class="px-5">If you like what we do, you can help us do more of that by supporting on Ko-Fi or GitHub:</p>
      </div>
      <div class="col-md-4 mb-5 mb-lg-0">
          <p class="px-5">Enjoyed this post? Consider subscribing to our newsletter to always be first to check out our new updates:</p>
      </div>
      <div class="col-md-4 mb-5 mb-lg-0">
          <p class="px-5">We also share our work elsewhere. You can find us also at:</p>
      </div>
  </div>

  <div class="row justify-content-center align-items-center">
      <div class="col-md-4 mb-5 mb-lg-0">
          <ul class="empty-list list-inline mb-0 mx-auto">
              <li class="list-inline-item my-auto">
                  <a class="btn btn-outline-primary btn-sm rounded-pill" href="https://ko-fi.com/kowainik" target="_blank">
                      <i class="fas fa-coffee"></i> Buy a coffee
                  </a>

              </li>
              <li class="list-inline-item my-auto">
                  <a class="btn btn-outline-primary btn-sm rounded-pill" href="https://github.com/sponsors/vrom911" target="_blank">
                      <i class="fab fa-github"></i> @vrom911
                  </a>
              </li>
              <li class="list-inline-item my-auto">
                  <a class="btn btn-outline-primary btn-sm rounded-pill" href="https://github.com/sponsors/chshersh" target="_blank">
                      <i class="fab fa-github"></i> @chshersh
                  </a>
              </li>
          </ul>
      </div>

      <div class="col-md-4 mb-5 mb-lg-0">
        <!-- Begin Mailchimp Signup Form -->
          <div class="row justify-content-center" id="mc_embed_signup">
  <form action="https://news.us2.list-manage.com/subscribe/post?u=af5d0411175f11e83618abf5e&amp;id=b04a7ed805" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div class="form-row mx-0" id="mc_embed_signup_scroll">
      <div class="col-8 input-group ">
        <div class="input-group-prepend">
          <div class="input-group-text"><i class="fa fa-envelope"></i> </div>
        </div>
        <input type="email" value name="EMAIL" class="required email form-control" placeholder="Your email" id="mce-EMAIL">
      </div>
      <div class="col-4 text-left">
        <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button btn btn-primary btn-lg">
      </div>
      <div class="mc-field-group group-checkbox input-group">
        <ul>
          <li><input type="checkbox" value="1" name="group[83780][1]" class="form-check-input" id="mce-group[83780]-83780-0"></li>
          <li><input type="checkbox" value="2" name="group[83780][2]" class="form-check-input" id="mce-group[83780]-83780-1" checked></li>
        </ul>
      </div>
      <div id="mce-responses" class="clear">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
      </div>
      <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_af5d0411175f11e83618abf5e_b04a7ed805" tabindex="-1" value></div>
    </div>
  </form>
</div>

    <!--End mc_embed_signup-->
    </div>
    <div class="col-md-4 mb-5 mb-lg-0">
        <ul class="empty-list list-inline mb-0 mx-auto">
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://twitter.com/kowainik" target="_blank">
                    <i class="fab fa-fw fa-twitter"></i>
                </a>
            </li>
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://github.com/kowainik" target="_blank">
                    <i class="fab fa-fw fa-github"></i>
                </a>
            </li>
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://www.linkedin.com/company/kowainik" target="_blank">
                    <i class="fab fa-fw fa-linkedin"></i>
                </a>
            </li>
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://t.me/kowainik" target="_blank">
                    <i class="fab fa-fw fa-telegram"></i>
                </a>
            </li>
            
            <li class="list-inline-item my-auto">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="../rss.xml" target="_blank">
                    <i class="fas fa-fw fa-rss"></i>
                </a>
            </li>
            
        </ul>
    </div>
  </div>
</footer>


      <!-- Bootstrap core JavaScript -->
      <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"> </script>
      <script src="../js/post.js"> </script>
      <script src="../js/hide.js"> </script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
      <script>hljs.initHighlightingOnLoad()</script>
      <script async defer src="https://buttons.github.io/buttons.js"></script>
  </body>
</html>
